"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _iproxy = _interopRequireDefault(require("../wda/iproxy"));

let commands = {};
exports.commands = commands;
const MAX_RECORDING_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const DEFAULT_MJPEG_SERVER_PORT = 9100;
const DEFAULT_FPS = 10;
const DEFAULT_QUALITY = 'medium';
const DEFAULT_VCODEC = 'mjpeg';
const MP4_EXT = '.mp4';
const FFMPEG_BINARY = 'ffmpeg';

const ffmpegLogger = _appiumSupport.logger.getLogger(FFMPEG_BINARY);

const QUALITY_MAPPING = {
  low: 10,
  medium: 25,
  high: 75,
  photo: 100
};

class ScreenRecorder {
  constructor(udid, videoPath, opts = {}) {
    this.videoPath = videoPath;
    this.opts = opts;
    this.udid = udid;
    this.mainProcess = null;
    this.iproxy = null;
    this.timeoutHandler = null;
  }

  async start(timeoutMs) {
    try {
      await _appiumSupport.fs.which(FFMPEG_BINARY);
    } catch (err) {
      throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
    }

    const localPort = this.opts.remotePort;

    if (this.opts.usePortForwarding) {
      await this.startIproxy(localPort);
    }

    const args = ['-f', 'mjpeg'];

    if (this.opts.videoFps && this.opts.videoType === 'libx264') {
      args.push('-r', this.opts.videoFps);
    }

    args.push('-i', `http://localhost:${localPort}`);

    if (this.opts.videoScale) {
      args.push('-vf', `scale=${this.opts.videoScale}`);
    }

    if (this.opts.pixelFormat) {
      args.push('-pix_fmt', this.opts.pixelFormat);
    }

    args.push('-vcodec', this.opts.videoType, '-y', this.videoPath);
    this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);
    this.mainProcess.on('output', (stdout, stderr) => {
      if (stderr && !stderr.includes('frame=')) {
        ffmpegLogger.info(`${stderr}`);
      }
    });
    await this.mainProcess.start(5000);

    _logger.default.info(`Starting screen capture on the device '${this.udid}' with command: '${FFMPEG_BINARY} ${args.join(' ')}'. ` + `Will timeout in ${timeoutMs}ms`);

    this.timeoutHandler = setTimeout(async () => {
      if (!(await this.interrupt())) {
        _logger.default.warn(`Cannot finish the active screen recording on the device '${this.udid}' after ${timeoutMs}ms timeout`);
      }
    }, timeoutMs);
  }

  async startIproxy(localPort) {
    this.iproxy = new _iproxy.default(this.udid, localPort, this.opts.remotePort);

    try {
      await this.iproxy.start();
    } catch (err) {
      _logger.default.warn(`Cannot start iproxy. Assuming it is already forwarding the remote port ${this.opts.remotePort} to ${localPort} ` + `for the device ${this.udid}. Set the custom value to 'mjpegServerPort' capability if this is an undesired behavior. ` + `Original error: ${err.message}`);

      this.iproxy = null;
    }
  }

  async stopIproxy() {
    if (!this.iproxy) {
      return;
    }

    const quitPromise = this.iproxy.quit();
    this.iproxy = null;

    try {
      await quitPromise;
    } catch (err) {
      _logger.default.warn(`Cannot stop iproxy. Original error: ${err.message}`);
    }
  }

  async interrupt(force = false) {
    let result = true;

    if (this.timeoutHandler) {
      clearTimeout(this.timeoutHandler);
      this.timeoutHandler = null;
    }

    if (this.mainProcess && this.mainProcess.isRunning) {
      const interruptPromise = this.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');
      this.mainProcess = null;

      try {
        await interruptPromise;
      } catch (e) {
        _logger.default.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);

        result = false;
      }
    }

    if (this.opts.usePortForwarding) {
      await this.stopIproxy();
    }

    return result;
  }

  async finish() {
    await this.interrupt();
    return this.videoPath;
  }

  async cleanup() {
    if (await _appiumSupport.fs.exists(this.videoPath)) {
      await _appiumSupport.fs.rimraf(this.videoPath);
    }
  }

}

commands.startRecordingScreen = async function (options = {}) {
  const {
    videoType = DEFAULT_VCODEC,
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    videoQuality = DEFAULT_QUALITY,
    videoFps = DEFAULT_FPS,
    videoScale,
    forceRestart
  } = options;
  let result = '';

  if (!forceRestart) {
    _logger.default.info(`Checking if there is/was a previous screen recording. ` + `Set 'forceRestart' option to 'true' if you'd like to skip this step.`);

    result = await this.stopRecordingScreen(options);
  }

  const videoPath = await _appiumSupport.tempDir.path({
    prefix: `appium_${Math.random().toString(16).substring(2, 8)}`,
    suffix: MP4_EXT
  });
  const screenRecorder = new ScreenRecorder(this.opts.device.udid, videoPath, {
    remotePort: this.opts.mjpegServerPort || DEFAULT_MJPEG_SERVER_PORT,
    usePortForwarding: this.isRealDevice(),
    videoType,
    videoScale,
    videoFps
  });

  if (!(await screenRecorder.interrupt(true))) {
    _logger.default.errorAndThrow('Unable to stop screen recording process');
  }

  if (this._recentScreenRecorder) {
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }

  const timeoutSeconds = parseFloat(timeLimit);

  if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
    _logger.default.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }

  let {
    mjpegServerScreenshotQuality,
    mjpegServerFramerate
  } = await this.proxyCommand('/appium/settings', 'GET');

  if (videoQuality) {
    const quality = _lodash.default.isInteger(videoQuality) ? videoQuality : QUALITY_MAPPING[_lodash.default.toLower(videoQuality)];

    if (!quality) {
      throw new Error(`videoQuality value should be one of ${JSON.stringify(_lodash.default.keys(QUALITY_MAPPING))} or a number in range 1..100. ` + `'${videoQuality}' is given instead`);
    }

    mjpegServerScreenshotQuality = mjpegServerScreenshotQuality !== quality ? quality : undefined;
  } else {
    mjpegServerScreenshotQuality = undefined;
  }

  if (videoFps) {
    const fps = parseInt(videoFps, 10);

    if (isNaN(fps)) {
      throw new Error(`videoFps value should be a valid number in range 1..60. ` + `'${videoFps}' is given instead`);
    }

    mjpegServerFramerate = mjpegServerFramerate !== fps ? fps : undefined;
  } else {
    mjpegServerFramerate = undefined;
  }

  if (_appiumSupport.util.hasValue(mjpegServerScreenshotQuality) || _appiumSupport.util.hasValue(mjpegServerFramerate)) {
    await this.proxyCommand('/appium/settings', 'POST', {
      mjpegServerScreenshotQuality,
      mjpegServerFramerate
    });
  }

  try {
    await screenRecorder.start(timeoutSeconds * 1000);
  } catch (e) {
    await screenRecorder.interrupt(true);
    await screenRecorder.cleanup();
    throw e;
  }

  this._recentScreenRecorder = screenRecorder;
  return result;
};

commands.stopRecordingScreen = async function (options = {}) {
  const {
    remotePath,
    user,
    pass,
    method
  } = options;

  if (!this._recentScreenRecorder) {
    _logger.default.info('Screen recording is not running. There is nothing to stop.');

    return '';
  }

  try {
    const videoPath = await this._recentScreenRecorder.finish();

    if (!(await _appiumSupport.fs.exists(videoPath))) {
      _logger.default.errorAndThrow(`The screen recorder utility has failed ` + `to store the actual screen recording at '${videoPath}'`);
    }

    return await (0, _utils.encodeBase64OrUpload)(videoPath, remotePath, {
      user,
      pass,
      method
    });
  } finally {
    await this._recentScreenRecorder.interrupt(true);
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmRzY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJNQVhfUkVDT1JESU5HX1RJTUVfU0VDIiwiREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMiLCJERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JUIiwiREVGQVVMVF9GUFMiLCJERUZBVUxUX1FVQUxJVFkiLCJERUZBVUxUX1ZDT0RFQyIsIk1QNF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiZmZtcGVnTG9nZ2VyIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiUVVBTElUWV9NQVBQSU5HIiwibG93IiwibWVkaXVtIiwiaGlnaCIsInBob3RvIiwiU2NyZWVuUmVjb3JkZXIiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ2aWRlb1BhdGgiLCJvcHRzIiwibWFpblByb2Nlc3MiLCJpcHJveHkiLCJ0aW1lb3V0SGFuZGxlciIsInN0YXJ0IiwidGltZW91dE1zIiwiZnMiLCJ3aGljaCIsImVyciIsIkVycm9yIiwibG9jYWxQb3J0IiwicmVtb3RlUG9ydCIsInVzZVBvcnRGb3J3YXJkaW5nIiwic3RhcnRJcHJveHkiLCJhcmdzIiwidmlkZW9GcHMiLCJ2aWRlb1R5cGUiLCJwdXNoIiwidmlkZW9TY2FsZSIsInBpeGVsRm9ybWF0IiwiU3ViUHJvY2VzcyIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5jbHVkZXMiLCJpbmZvIiwibG9nIiwiam9pbiIsInNldFRpbWVvdXQiLCJpbnRlcnJ1cHQiLCJ3YXJuIiwiaVByb3h5IiwibWVzc2FnZSIsInN0b3BJcHJveHkiLCJxdWl0UHJvbWlzZSIsInF1aXQiLCJmb3JjZSIsInJlc3VsdCIsImNsZWFyVGltZW91dCIsImlzUnVubmluZyIsImludGVycnVwdFByb21pc2UiLCJzdG9wIiwiZSIsImZpbmlzaCIsImNsZWFudXAiLCJleGlzdHMiLCJyaW1yYWYiLCJzdGFydFJlY29yZGluZ1NjcmVlbiIsIm9wdGlvbnMiLCJ0aW1lTGltaXQiLCJ2aWRlb1F1YWxpdHkiLCJmb3JjZVJlc3RhcnQiLCJzdG9wUmVjb3JkaW5nU2NyZWVuIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJNYXRoIiwicmFuZG9tIiwidG9TdHJpbmciLCJzdWJzdHJpbmciLCJzdWZmaXgiLCJzY3JlZW5SZWNvcmRlciIsImRldmljZSIsIm1qcGVnU2VydmVyUG9ydCIsImlzUmVhbERldmljZSIsImVycm9yQW5kVGhyb3ciLCJfcmVjZW50U2NyZWVuUmVjb3JkZXIiLCJ0aW1lb3V0U2Vjb25kcyIsInBhcnNlRmxvYXQiLCJpc05hTiIsIm1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkiLCJtanBlZ1NlcnZlckZyYW1lcmF0ZSIsInByb3h5Q29tbWFuZCIsInF1YWxpdHkiLCJfIiwiaXNJbnRlZ2VyIiwidG9Mb3dlciIsIkpTT04iLCJzdHJpbmdpZnkiLCJrZXlzIiwidW5kZWZpbmVkIiwiZnBzIiwicGFyc2VJbnQiLCJ1dGlsIiwiaGFzVmFsdWUiLCJyZW1vdGVQYXRoIiwidXNlciIsInBhc3MiLCJtZXRob2QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O0FBRUEsTUFBTUMsc0JBQXNCLEdBQUcsS0FBSyxFQUFwQztBQUNBLE1BQU1DLDBCQUEwQixHQUFHLEtBQUssQ0FBeEM7QUFDQSxNQUFNQyx5QkFBeUIsR0FBRyxJQUFsQztBQUNBLE1BQU1DLFdBQVcsR0FBRyxFQUFwQjtBQUNBLE1BQU1DLGVBQWUsR0FBRyxRQUF4QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxPQUF2QjtBQUNBLE1BQU1DLE9BQU8sR0FBRyxNQUFoQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxRQUF0Qjs7QUFDQSxNQUFNQyxZQUFZLEdBQUdDLHNCQUFPQyxTQUFQLENBQWlCSCxhQUFqQixDQUFyQjs7QUFDQSxNQUFNSSxlQUFlLEdBQUc7QUFDdEJDLEVBQUFBLEdBQUcsRUFBRSxFQURpQjtBQUV0QkMs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LFNBQVMsR0FBRyxNQUFNLEtBQUttRSxxQkFBTCxDQUEyQnZCLE1BQTNCLEVBQXhCOztBQUNBLFFBQUksRUFBQyxNQUFNckMsa0JBQUd1QyxNQUFILENBQVU5QyxTQUFWLENBQVAsQ0FBSixFQUFpQztBQUMvQjJCLHNCQUFJdUMsYUFBSixDQUFtQix5Q0FBRCxHQUNmLDRDQUEyQ2xFLFNBQVUsR0FEeEQ7QUFFRDs7QUFDRCxXQUFPLE1BQU0saUNBQXFCQSxTQUFyQixFQUFnQ3NGLFVBQWhDLEVBQTRDO0FBQ3ZEQyxNQUFBQSxJQUR1RDtBQUV2REMsTUFBQUEsSUFGdUQ7QUFHdkRDLE1BQUFBO0FBSHVELEtBQTVDLENBQWI7QUFLRCxHQVhELFNBV1U7QUFDUixVQUFNLEtBQUt0QixxQkFBTCxDQUEyQnJDLFNBQTNCLENBQXFDLElBQXJDLENBQU47QUFDQSxVQUFNLEtBQUtxQyxxQkFBTCxDQUEyQnRCLE9BQTNCLEVBQU47QUFDQSxTQUFLc0IscUJBQUwsR0FBNkIsSUFBN0I7QUFDRDtBQUNGLENBN0JEOztlQWlDZXZGLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIsIGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgaVByb3h5IGZyb20gJy4uL3dkYS9pcHJveHknO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgTUFYX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMzA7XG5jb25zdCBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMztcbmNvbnN0IERFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQgPSA5MTAwO1xuY29uc3QgREVGQVVMVF9GUFMgPSAxMDtcbmNvbnN0IERFRkFVTFRfUVVBTElUWSA9ICdtZWRpdW0nO1xuY29uc3QgREVGQVVMVF9WQ09ERUMgPSAnbWpwZWcnO1xuY29uc3QgTVA0X0VYVCA9ICcubXA0JztcbmNvbnN0IEZGTVBFR19CSU5BUlkgPSAnZmZtcGVnJztcbmNvbnN0IGZmbXBlZ0xvZ2dlciA9IGxvZ2dlci5nZXRMb2dnZXIoRkZNUEVHX0JJTkFSWSk7XG5jb25zdCBRVUFMSVRZX01BUFBJTkcgPSB7XG4gIGxvdzogMTAsXG4gIG1lZGl1bTogMjUsXG4gIGhpZ2g6IDc1LFxuICBwaG90bzogMTAwLFxufTtcblxuXG5jbGFzcyBTY3JlZW5SZWNvcmRlciB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB2aWRlb1BhdGgsIG9wdHMgPSB7fSkge1xuICAgIHRoaXMudmlkZW9QYXRoID0gdmlkZW9QYXRoO1xuICAgIHRoaXMub3B0cyA9IG9wdHM7XG4gICAgdGhpcy51ZGlkID0gdWRpZDtcbiAgICB0aGlzLm1haW5Qcm9jZXNzID0gbnVsbDtcbiAgICB0aGlzLmlwcm94eSA9IG51bGw7XG4gICAgdGhpcy50aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydCAodGltZW91dE1zKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZzLndoaWNoKEZGTVBFR19CSU5BUlkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtGRk1QRUdfQklOQVJZfScgYmluYXJ5IGlzIG5vdCBmb3VuZCBpbiBQQVRILiBJbnN0YWxsIGl0IHVzaW5nICdicmV3IGluc3RhbGwgZmZtcGVnJy4gYCArXG4gICAgICAgIGBDaGVjayBodHRwczovL3d3dy5mZm1wZWcub3JnL2Rvd25sb2FkLmh0bWwgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgICB9XG5cbiAgICBjb25zdCBsb2NhbFBvcnQgPSB0aGlzLm9wdHMucmVtb3RlUG9ydDtcbiAgICBpZiAodGhpcy5vcHRzLnVzZVBvcnRGb3J3YXJkaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0SXByb3h5KGxvY2FsUG9ydCk7XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctZicsICdtanBlZycsXG4gICAgXTtcbiAgICAvL1BhcmFtZXRlciBgLXJgIGlzIG9wdGlvbmFsLiBTZWUgZGV0YWlsczogaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzEyMDY3XG4gICAgaWYgKHRoaXMub3B0cy52aWRlb0ZwcyAmJiB0aGlzLm9wdHMudmlkZW9UeXBlID09PSAnbGlieDI2NCcpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXInLCB0aGlzLm9wdHMudmlkZW9GcHMpO1xuICAgIH1cbiAgICBhcmdzLnB1c2goJy1pJywgYGh0dHA6Ly9sb2NhbGhvc3Q6JHtsb2NhbFBvcnR9YCk7XG4gICAgaWYgKHRoaXMub3B0cy52aWRlb1NjYWxlKSB7XG4gICAgICBhcmdzLnB1c2goJy12ZicsIGBzY2FsZT0ke3RoaXMub3B0cy52aWRlb1NjYWxlfWApO1xuICAgIH1cbiAgICAvLyBRdWlja3RpbWUgY29tcGF0aWJpbGl0eSB2aWEgcGl4ZWxGb3JtYXQ6ICd5dXY0MjBwJ1xuICAgIGlmICh0aGlzLm9wdHMucGl4ZWxGb3JtYXQpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXBpeF9mbXQnLCB0aGlzLm9wdHMucGl4ZWxGb3JtYXQpO1xuICAgIH1cbiAgICBhcmdzLnB1c2goXG4gICAgICAnLXZjb2RlYycsIHRoaXMub3B0cy52aWRlb1R5cGUsXG4gICAgICAnLXknLCB0aGlzLnZpZGVvUGF0aFxuICAgICk7XG4gICAgdGhpcy5tYWluUHJvY2VzcyA9IG5ldyBTdWJQcm9jZXNzKEZGTVBFR19CSU5BUlksIGFyZ3MpO1xuICAgIHRoaXMubWFpblByb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKHN0ZGVyciAmJiAhc3RkZXJyLmluY2x1ZGVzKCdmcmFtZT0nKSkge1xuICAgICAgICBmZm1wZWdMb2dnZXIuaW5mbyhgJHtzdGRlcnJ9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gR2l2ZSBmZm1wZWcgc29tZSB0aW1lIGZvciBpbml0XG4gICAgYXdhaXQgdGhpcy5tYWluUHJvY2Vzcy5zdGFydCg1MDAwKTtcbiAgICBsb2cuaW5mbyhgU3RhcnRpbmcgc2NyZWVuIGNhcHR1cmUgb24gdGhlIGRldmljZSAnJHt0aGlzLnVkaWR9JyB3aXRoIGNvbW1hbmQ6ICcke0ZGTVBFR19CSU5BUll9ICR7YXJncy5qb2luKCcgJyl9Jy4gYCArXG4gICAgICBgV2lsbCB0aW1lb3V0IGluICR7dGltZW91dE1zfW1zYCk7XG5cbiAgICB0aGlzLnRpbWVvdXRIYW5kbGVyID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoIWF3YWl0IHRoaXMuaW50ZXJydXB0KCkpIHtcbiAgICAgICAgbG9nLndhcm4oYENhbm5vdCBmaW5pc2ggdGhlIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nIG9uIHRoZSBkZXZpY2UgJyR7dGhpcy51ZGlkfScgYWZ0ZXIgJHt0aW1lb3V0TXN9bXMgdGltZW91dGApO1xuICAgICAgfVxuICAgIH0sIHRpbWVvdXRNcyk7XG4gIH1cblxuICBhc3luYyBzdGFydElwcm94eSAobG9jYWxQb3J0KSB7XG4gICAgdGhpcy5pcHJveHkgPSBuZXcgaVByb3h5KHRoaXMudWRpZCwgbG9jYWxQb3J0LCB0aGlzLm9wdHMucmVtb3RlUG9ydCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuaXByb3h5LnN0YXJ0KCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ2Fubm90IHN0YXJ0IGlwcm94eS4gQXNzdW1pbmcgaXQgaXMgYWxyZWFkeSBmb3J3YXJkaW5nIHRoZSByZW1vdGUgcG9ydCAke3RoaXMub3B0cy5yZW1vdGVQb3J0fSB0byAke2xvY2FsUG9ydH0gYCArXG4gICAgICAgIGBmb3IgdGhlIGRldmljZSAke3RoaXMudWRpZH0uIFNldCB0aGUgY3VzdG9tIHZhbHVlIHRvICdtanBlZ1NlcnZlclBvcnQnIGNhcGFiaWxpdHkgaWYgdGhpcyBpcyBhbiB1bmRlc2lyZWQgYmVoYXZpb3IuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB0aGlzLmlwcm94eSA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RvcElwcm94eSAoKSB7XG4gICAgaWYgKCF0aGlzLmlwcm94eSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHF1aXRQcm9taXNlID0gdGhpcy5pcHJveHkucXVpdCgpO1xuICAgIHRoaXMuaXByb3h5ID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcXVpdFByb21pc2U7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ2Fubm90IHN0b3AgaXByb3h5LiBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnRlcnJ1cHQgKGZvcmNlID0gZmFsc2UpIHtcbiAgICBsZXQgcmVzdWx0ID0gdHJ1ZTtcblxuICAgIGlmICh0aGlzLnRpbWVvdXRIYW5kbGVyKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SGFuZGxlcik7XG4gICAgICB0aGlzLnRpbWVvdXRIYW5kbGVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5tYWluUHJvY2VzcyAmJiB0aGlzLm1haW5Qcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgY29uc3QgaW50ZXJydXB0UHJvbWlzZSA9IHRoaXMubWFpblByb2Nlc3Muc3RvcChmb3JjZSA/ICdTSUdURVJNJyA6ICdTSUdJTlQnKTtcbiAgICAgIHRoaXMubWFpblByb2Nlc3MgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgaW50ZXJydXB0UHJvbWlzZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oYENhbm5vdCAke2ZvcmNlID8gJ3Rlcm1pbmF0ZScgOiAnaW50ZXJydXB0J30gJHtGRk1QRUdfQklOQVJZfS4gYCArXG4gICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgICAgcmVzdWx0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0cy51c2VQb3J0Rm9yd2FyZGluZykge1xuICAgICAgYXdhaXQgdGhpcy5zdG9wSXByb3h5KCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGFzeW5jIGZpbmlzaCAoKSB7XG4gICAgYXdhaXQgdGhpcy5pbnRlcnJ1cHQoKTtcbiAgICByZXR1cm4gdGhpcy52aWRlb1BhdGg7XG4gIH1cblxuICBhc3luYyBjbGVhbnVwICgpIHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHRoaXMudmlkZW9QYXRoKSkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHRoaXMudmlkZW9QYXRoKTtcbiAgICB9XG4gIH1cbn1cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXJ0UmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG9pbnQgcmVzcG9uc2UgdmFsdWUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9wdGlvbiBvbmx5IGhhcyBhbiBlZmZlY3QgaWYgdGhlcmUgaXMgc2NyZWVuIHJlY29yZGluZyBwcm9jZXNzIGluIHByb2dyZXNzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgYGZvcmNlUmVzdGFydGAgcGFyYW1ldGVyIGlzIG5vdCBzZXQgdG8gYHRydWVgLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwYXNzIC0gVGhlIHBhc3N3b3JkIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb1R5cGUgLSBUaGUgdmlkZW8gY29kZWMgdHlwZSB1c2VkIGZvciBlbmNvZGluZyBvZiB0aGUgYmUgcmVjb3JkZWQgc2NyZWVuIGNhcHR1cmUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEV4ZWN1dGUgYGZmbXBlZyAtY29kZWNzYCBpbiB0aGUgdGVybWluYWwgdG8gc2VlIHRoZSBsaXN0IG9mIHN1cHBvcnRlZCB2aWRlbyBjb2RlY3MuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtanBlZycgYnkgZGVmYXVsdC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ3xudW1iZXJ9IHZpZGVvUXVhbGl0eSAtIFRoZSB2aWRlbyBlbmNvZGluZyBxdWFsaXR5IChsb3csIG1lZGl1bSwgaGlnaCwgcGhvdG8gLSBkZWZhdWx0cyB0byBtZWRpdW0pLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdmlkZW9GcHMgLSBUaGUgRnJhbWVzIFBlciBTZWNvbmQgcmF0ZSBvZiB0aGUgcmVjb3JkZWQgdmlkZW8uIENoYW5nZSB0aGlzIHZhbHVlIGlmIHRoZSByZXN1bHRpbmcgdmlkZW9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpcyB0b28gc2xvdyBvciB0b28gZmFzdC4gRGVmYXVsdHMgdG8gMTAuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZpZGVvU2NhbGUgLSBUaGUgc2NhbGluZyB2YWx1ZSB0byBhcHBseS4gUmVhZCBodHRwczovL3RyYWMuZmZtcGVnLm9yZy93aWtpL1NjYWxpbmcgZm9yIHBvc3NpYmxlIHZhbHVlcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5vIHNjYWxlIGlzIGFwcGxpZWQgYnkgZGVmYXVsdC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGl4ZWxGb3JtYXQgLSBPdXRwdXQgcGl4ZWwgZm9ybWF0LiBSdW4gYGZmbXBlZyAtcGl4X2ZtdHNgIHRvIGxpc3QgcG9zc2libGUgdmFsdWVzLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZvciBRdWlja3RpbWUgY29tcGF0aWJpbGl0eSwgc2V0IHRvIFwieXV2NDIwcFwiIGFsb25nIHdpdGggdmlkZW9UeXBlOiBcImxpYngyNjRcIi5cbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGZvcmNlUmVzdGFydCAtIFdoZXRoZXIgdG8gdHJ5IHRvIGNhdGNoIGFuZCB1cGxvYWQvcmV0dXJuIHRoZSBjdXJyZW50bHkgcnVubmluZyBzY3JlZW4gcmVjb3JkaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYGZhbHNlYCwgdGhlIGRlZmF1bHQgc2V0dGluZykgb3IgaWdub3JlIHRoZSByZXN1bHQgb2YgaXQgYW5kIHN0YXJ0IGEgbmV3IHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1tZWRpYXRlbHkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSB0aW1lTGltaXQgLSBUaGUgbWF4aW11bSByZWNvcmRpbmcgdGltZSwgaW4gc2Vjb25kcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDE4MCwgdGhlIG1heGltdW0gdmFsdWUgaXMgNjAwICgxMCBtaW51dGVzKS5cbiAqL1xuXG4vKipcbiAqIFJlY29yZCB0aGUgZGlzcGxheSBvZiBkZXZpY2VzIHJ1bm5pbmcgaU9TIFNpbXVsYXRvciBzaW5jZSBYY29kZSA5IG9yIHJlYWwgZGV2aWNlcyBzaW5jZSBpT1MgMTFcbiAqIChmZm1wZWcgdXRpbGl0eSBpcyByZXF1aXJlZDogJ2JyZXcgaW5zdGFsbCBmZm1wZWcnKS5cbiAqIEl0IHJlY29yZHMgc2NyZWVuIGFjdGl2aXR5IHRvIGEgTVBFRy00IGZpbGUuIEF1ZGlvIGlzIG5vdCByZWNvcmRlZCB3aXRoIHRoZSB2aWRlbyBmaWxlLlxuICogSWYgc2NyZWVuIHJlY29yZGluZyBoYXMgYmVlbiBhbHJlYWR5IHN0YXJ0ZWQgdGhlbiB0aGUgY29tbWFuZCB3aWxsIHN0b3AgaXQgZm9yY2VmdWxseSBhbmQgc3RhcnQgYSBuZXcgb25lLlxuICogVGhlIHByZXZpb3VzbHkgcmVjb3JkZWQgdmlkZW8gZmlsZSB3aWxsIGJlIGRlbGV0ZWQuXG4gKlxuICogQHBhcmFtIHs/U3RhcnRSZWNvcmRpbmdPcHRpb25zfSBvcHRpb25zIC0gVGhlIGF2YWlsYWJsZSBvcHRpb25zLlxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgcmVjb3JkZWQgbWVkaWEgZmlsZSBpZlxuICogICAgICAgICAgICAgICAgICAgYW55IHNjcmVlbiByZWNvcmRpbmcgaXMgY3VycmVudGx5IHJ1bm5pbmcgb3IgYW4gZW1wdHkgc3RyaW5nLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBzdGFydC5cbiAqL1xuY29tbWFuZHMuc3RhcnRSZWNvcmRpbmdTY3JlZW4gPSBhc3luYyBmdW5jdGlvbiAob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB2aWRlb1R5cGUgPSBERUZBVUxUX1ZDT0RFQyxcbiAgICB0aW1lTGltaXQgPSBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyxcbiAgICB2aWRlb1F1YWxpdHkgPSBERUZBVUxUX1FVQUxJVFksXG4gICAgdmlkZW9GcHMgPSBERUZBVUxUX0ZQUyxcbiAgICB2aWRlb1NjYWxlLFxuICAgIGZvcmNlUmVzdGFydCxcbiAgfSA9IG9wdGlvbnM7XG5cbiAgbGV0IHJlc3VsdCA9ICcnO1xuICBpZiAoIWZvcmNlUmVzdGFydCkge1xuICAgIGxvZy5pbmZvKGBDaGVja2luZyBpZiB0aGVyZSBpcy93YXMgYSBwcmV2aW91cyBzY3JlZW4gcmVjb3JkaW5nLiBgICtcbiAgICAgIGBTZXQgJ2ZvcmNlUmVzdGFydCcgb3B0aW9uIHRvICd0cnVlJyBpZiB5b3UnZCBsaWtlIHRvIHNraXAgdGhpcyBzdGVwLmApO1xuICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMuc3RvcFJlY29yZGluZ1NjcmVlbihvcHRpb25zKTtcbiAgfVxuXG4gIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgcHJlZml4OiBgYXBwaXVtXyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDIsIDgpfWAsXG4gICAgc3VmZml4OiBNUDRfRVhULFxuICB9KTtcblxuICBjb25zdCBzY3JlZW5SZWNvcmRlciA9IG5ldyBTY3JlZW5SZWNvcmRlcih0aGlzLm9wdHMuZGV2aWNlLnVkaWQsIHZpZGVvUGF0aCwge1xuICAgIHJlbW90ZVBvcnQ6IHRoaXMub3B0cy5tanBlZ1NlcnZlclBvcnQgfHwgREVGQVVMVF9NSlBFR19TRVJWRVJfUE9SVCxcbiAgICB1c2VQb3J0Rm9yd2FyZGluZzogdGhpcy5pc1JlYWxEZXZpY2UoKSxcbiAgICB2aWRlb1R5cGUsXG4gICAgdmlkZW9TY2FsZSxcbiAgICB2aWRlb0Zwc1xuICB9KTtcbiAgaWYgKCFhd2FpdCBzY3JlZW5SZWNvcmRlci5pbnRlcnJ1cHQodHJ1ZSkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnVW5hYmxlIHRvIHN0b3Agc2NyZWVuIHJlY29yZGluZyBwcm9jZXNzJyk7XG4gIH1cbiAgaWYgKHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyKSB7XG4gICAgYXdhaXQgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIuY2xlYW51cCgpO1xuICAgIHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyID0gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHRpbWVvdXRTZWNvbmRzID0gcGFyc2VGbG9hdCh0aW1lTGltaXQpO1xuICBpZiAoaXNOYU4odGltZW91dFNlY29uZHMpIHx8IHRpbWVvdXRTZWNvbmRzID4gTUFYX1JFQ09SRElOR19USU1FX1NFQyB8fCB0aW1lb3V0U2Vjb25kcyA8PSAwKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSB0aW1lTGltaXQgdmFsdWUgbXVzdCBiZSBpbiByYW5nZSBbMSwgJHtNQVhfUkVDT1JESU5HX1RJTUVfU0VDfV0gc2Vjb25kcy4gYCArXG4gICAgICBgVGhlIHZhbHVlIG9mICcke3RpbWVMaW1pdH0nIGhhcyBiZWVuIHBhc3NlZCBpbnN0ZWFkLmApO1xuICB9XG5cbiAgbGV0IHtcbiAgICBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5LFxuICAgIG1qcGVnU2VydmVyRnJhbWVyYXRlLFxuICB9ID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hcHBpdW0vc2V0dGluZ3MnLCAnR0VUJyk7XG4gIGlmICh2aWRlb1F1YWxpdHkpIHtcbiAgICBjb25zdCBxdWFsaXR5ID0gXy5pc0ludGVnZXIodmlkZW9RdWFsaXR5KSA/IHZpZGVvUXVhbGl0eSA6IFFVQUxJVFlfTUFQUElOR1tfLnRvTG93ZXIodmlkZW9RdWFsaXR5KV07XG4gICAgaWYgKCFxdWFsaXR5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHZpZGVvUXVhbGl0eSB2YWx1ZSBzaG91bGQgYmUgb25lIG9mICR7SlNPTi5zdHJpbmdpZnkoXy5rZXlzKFFVQUxJVFlfTUFQUElORykpfSBvciBhIG51bWJlciBpbiByYW5nZSAxLi4xMDAuIGAgK1xuICAgICAgICBgJyR7dmlkZW9RdWFsaXR5fScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICAgIH1cbiAgICBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5ID0gbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSAhPT0gcXVhbGl0eSA/IHF1YWxpdHkgOiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSA9IHVuZGVmaW5lZDtcbiAgfVxuICBpZiAodmlkZW9GcHMpIHtcbiAgICBjb25zdCBmcHMgPSBwYXJzZUludCh2aWRlb0ZwcywgMTApO1xuICAgIGlmIChpc05hTihmcHMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHZpZGVvRnBzIHZhbHVlIHNob3VsZCBiZSBhIHZhbGlkIG51bWJlciBpbiByYW5nZSAxLi42MC4gYCArXG4gICAgICAgIGAnJHt2aWRlb0Zwc30nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUgPSBtanBlZ1NlcnZlckZyYW1lcmF0ZSAhPT0gZnBzID8gZnBzIDogdW5kZWZpbmVkO1xuICB9IGVsc2Uge1xuICAgIG1qcGVnU2VydmVyRnJhbWVyYXRlID0gdW5kZWZpbmVkO1xuICB9XG4gIGlmICh1dGlsLmhhc1ZhbHVlKG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkpIHx8IHV0aWwuaGFzVmFsdWUobWpwZWdTZXJ2ZXJGcmFtZXJhdGUpKSB7XG4gICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hcHBpdW0vc2V0dGluZ3MnLCAnUE9TVCcsIHtcbiAgICAgIG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHksXG4gICAgICBtanBlZ1NlcnZlckZyYW1lcmF0ZSxcbiAgICB9KTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgc2NyZWVuUmVjb3JkZXIuc3RhcnQodGltZW91dFNlY29uZHMgKiAxMDAwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGF3YWl0IHNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCBzY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhyb3cgZTtcbiAgfVxuICB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlciA9IHNjcmVlblJlY29yZGVyO1xuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0b3BSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqL1xuXG4vKipcbiAqIFN0b3AgcmVjb3JkaW5nIHRoZSBzY3JlZW4uIElmIG5vIHNjcmVlbiByZWNvcmRpbmcgcHJvY2VzcyBpcyBydW5uaW5nIHRoZW5cbiAqIHRoZSBlbmRwb2ludCB3aWxsIHRyeSB0byBnZXQgdGhlIHJlY2VudGx5IHJlY29yZGVkIGZpbGUuXG4gKiBJZiBubyBwcmV2aW91c2x5IHJlY29yZGVkIGZpbGUgaXMgZm91bmQgYW5kIG5vIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nXG4gKiBwcm9jZXNzZXMgYXJlIHJ1bm5pbmcgdGhlbiB0aGUgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nLlxuICpcbiAqIEBwYXJhbSB7P1N0b3BSZWNvcmRpbmdPcHRpb25zfSBvcHRpb25zIC0gVGhlIGF2YWlsYWJsZSBvcHRpb25zLlxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgcmVjb3JkZWQgbWVkaWEgZmlsZSBpZiAncmVtb3RlUGF0aCdcbiAqICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlciBpcyBlbXB0eSBvciBudWxsIG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgbmFtZSBvZiBhIG1lZGlhIGZpbGVcbiAqICAgICAgICAgICAgICAgICBvciB0aGUgZmlsZSBjb250ZW50IGNhbm5vdCBiZSB1cGxvYWRlZCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLlxuICovXG5jb21tYW5kcy5zdG9wUmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcmVtb3RlUGF0aCxcbiAgICB1c2VyLFxuICAgIHBhc3MsXG4gICAgbWV0aG9kLFxuICB9ID0gb3B0aW9ucztcblxuICBpZiAoIXRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmluZm8oJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcC4nKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmZpbmlzaCgpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHZpZGVvUGF0aCkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgc2NyZWVuIHJlY29yZGVyIHV0aWxpdHkgaGFzIGZhaWxlZCBgICtcbiAgICAgICAgYHRvIHN0b3JlIHRoZSBhY3R1YWwgc2NyZWVuIHJlY29yZGluZyBhdCAnJHt2aWRlb1BhdGh9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgZW5jb2RlQmFzZTY0T3JVcGxvYWQodmlkZW9QYXRoLCByZW1vdGVQYXRoLCB7XG4gICAgICB1c2VyLFxuICAgICAgcGFzcyxcbiAgICAgIG1ldGhvZFxuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3JlY29yZHNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
