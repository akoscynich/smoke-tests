"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AppiumDriver = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _config = require("./config");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumFakeDriver = require("appium-fake-driver");

var _appiumAndroidDriver = require("appium-android-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumUiautomator2Driver = require("appium-uiautomator2-driver");

var _appiumSelendroidDriver = require("appium-selendroid-driver");

var _appiumXcuitestDriver = require("appium-xcuitest-driver");

var _appiumYouiengineDriver = require("appium-youiengine-driver");

var _appiumWindowsDriver = require("appium-windows-driver");

var _appiumMacDriver = require("appium-mac-driver");

var _appiumEspressoDriver = require("appium-espresso-driver");

var _appiumTizenDriver = require("appium-tizen-driver");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _utils = require("./utils");

var _semver = _interopRequireDefault(require("semver"));

const PLATFORMS = {
  FAKE: 'fake',
  ANDROID: 'android',
  IOS: 'ios',
  WINDOWS: 'windows',
  MAC: 'mac',
  TIZEN: 'tizen'
};
const AUTOMATION_NAMES = {
  APPIUM: 'Appium',
  SELENDROID: 'Selendroid',
  UIAUTOMATOR2: 'UiAutomator2',
  UIAUTOMATOR1: 'UiAutomator1',
  XCUITEST: 'XCUITest',
  YOUIENGINE: 'YouiEngine',
  ESPRESSO: 'Espresso',
  TIZEN: 'Tizen',
  FAKE: 'Fake',
  INSTRUMENTS: 'Instruments'
};
const DRIVER_MAP = {
  SelendroidDriver: {
    driverClass: _appiumSelendroidDriver.SelendroidDriver,
    automationName: AUTOMATION_NAMES.SELENDROID,
    version: (0, _utils.getPackageVersion)('appium-selendroid-driver')
  },
  AndroidUiautomator2Driver: {
    driverClass: _appiumUiautomator2Driver.AndroidUiautomator2Driver,
    automationName: AUTOMATION_NAMES.UIAUTOMATOR2,
    version: (0, _utils.getPackageVersion)('appium-uiautomator2-driver')
  },
  XCUITestDriver: {
    driverClass: _appiumXcuitestDriver.XCUITestDriver,
    automationName: AUTOMATION_NAMES.XCUITEST,
    version: (0, _utils.getPackageVersion)('appium-xcuitest-driver')
  },
  YouiEngineDriver: {
    driverClass: _appiumYouiengineDriver.YouiEngineDriver,
    automationName: AUTOMATION_NAMES.YOUIENGINE,
    version: (0, _utils.getPackageVersion)('appium-youiengine-driver')
  },
  FakeDriver: {
    driverClass: _appiumFakeDriver.FakeDriver,
    version: (0, _utils.getPackageVersion)('appium-fake-driver')
  },
  AndroidDriver: {
    driverClass: _appiumAndroidDriver.AndroidDriver,
    automationName: AUTOMATION_NAMES.UIAUTOMATOR1,
    version: (0, _utils.getPackageVersion)('appium-android-driver')
  },
  IosDriver: {
    driverClass: _appiumIosDriver.IosDriver,
    automationName: AUTOMATION_NAMES.INSTRUMENTS,
    version: (0, _utils.getPackageVersion)('appium-ios-driver')
  },
  WindowsDriver: {
    driverClass: _appiumWindowsDriver.WindowsDriver,
    version: (0, _utils.getPackageVersion)('appium-windows-driver')
  },
  MacDriver: {
    driverClass: _appiumMacDriver.MacDriver,
    version: (0, _utils.getPackageVersion)('appium-mac-driver')
  },
  EspressoDriver: {
    driverClass: _appiumEspressoDriver.EspressoDriver,
    automationName: AUTOMATION_NAMES.ESPRESSO,
    version: (0, _utils.getPackageVersion)('appium-espresso-driver')
  },
  TizenDriver: {
    driverClass: _appiumTizenDriver.TizenDriver,
    automationName: AUTOMATION_NAMES.TIZEN,
    version: (0, _utils.getPackageVersion)('appium-tizen-driver')
  }
};
const PLATFORMS_MAP = {
  [PLATFORMS.FAKE]: () => _appiumFakeDriver.FakeDriver,
  [PLATFORMS.ANDROID]: caps => {
    const platformVersion = _semver.default.valid(_semver.default.coerce(caps.platformVersion));

    _logger.default.warn(`DeprecationWarning: 'automationName' capability was not provided. ` + `Future versions of Appium will require 'automationName' capability to be set for Android sessions.`);

    _logger.default.info(`Setting automation to '${AUTOMATION_NAMES.UIAUTOMATOR1}'. `);

    if (platformVersion && _semver.default.satisfies(platformVersion, '>=6.0.0')) {
      _logger.default.warn(`Consider setting 'automationName' capability to '${AUTOMATION_NAMES.UIAUTOMATOR2}' ` + 'on Android >= 6, since UIAutomator1 framework ' + 'is not maintained anymore by the OS vendor.');
    }

    return _appiumAndroidDriver.AndroidDriver;
  },
  [PLATFORMS.IOS]: caps => {
    const platformVersion = _semver.default.valid(_semver.default.coerce(caps.platformVersion));

    _logger.default.warn(`DeprecationWarning: 'automationName' capability was not provided. ` + `Future versions of Appium will require 'automationName' capability to be set for iOS sessions.`);

    if (platformVersion && _semver.default.satisfies(platformVersion, '>=10.0.0')) {
      _logger.default.info("Requested iOS support with version >= 10, " + `using '${AUTOMATION_NAMES.XCUITEST}' ` + "driver instead of UIAutomation-based driver, since the " + "latter is unsupported on iOS 10 and up.");

      return _appiumXcuitestDriver.XCUITestDriver;
    }

    return _appiumIosDriver.IosDriver;
  },
  [PLATFORMS.WINDOWS]: () => _appiumWindowsDriver.WindowsDriver,
  [PLATFORMS.MAC]: () => _appiumMacDriver.MacDriver,
  [PLATFORMS.TIZEN]: () => _appiumTizenDriver.TizenDriver
};
const desiredCapabilityConstraints = {
  automationName: {
    presence: false,
    isString: true,
    inclusionCaseInsensitive: _lodash.default.values(AUTOMATION_NAMES)
  },
  platformName: {
    presence: true,
    isString: true,
    inclusionCaseInsensitive: _lodash.default.keys(PLATFORMS_MAP)
  }
};
const sessionsListGuard = new _asyncLock.default();
const pendingDriversGuard = new _asyncLock.default();

class AppiumDriver extends _appiumBaseDriver.BaseDriver {
  constructor(args) {
    super();
    this.desiredCapConstraints = desiredCapabilityConstraints;
    this.newCommandTimeoutMs = 0;
    this.args = Object.assign({}, args);
    this.sessions = {};
    this.pendingDrivers = {};
    (0, _config.updateBuildInfo)();
  }

  get isCommandsQueueEnabled() {
    return false;
  }

  sessionExists(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession && dstSession.sessionId !== null;
  }

  driverForSession(sessionId) {
    return this.sessions[sessionId];
  }

  getDriverForCaps(caps) {
    if (!_lodash.default.isString(caps.platformName)) {
      throw new Error("You must include a platformName capability");
    }

    const platformName = caps.platformName.toLowerCase();

    if (_lodash.default.isString(caps.automationName)) {
      for (const _ref of _lodash.default.values(DRIVER_MAP)) {
        const {
          automationName,
          driverClass
        } = _ref;

        if (_lodash.default.toLower(automationName) === caps.automationName.toLowerCase()) {
          return driverClass;
        }
      }
    }

    const driverSelector = PLATFORMS_MAP[platformName];

    if (driverSelector) {
      return driverSelector(caps);
    }

    const msg = _lodash.default.isString(caps.automationName) ? `Could not find a driver for automationName '${caps.automationName}' and platformName ` + `'${caps.platformName}'.` : `Could not find a driver for platformName '${caps.platformName}'.`;
    throw new Error(`${msg} Please check your desired capabilities.`);
  }

  getDriverVersion(driver) {
    const {
      version
    } = DRIVER_MAP[driver.name] || {};

    if (version) {
      return version;
    }

    _logger.default.warn(`Unable to get version of driver '${driver.name}'`);
  }

  async getStatus() {
    return {
      build: _lodash.default.clone((0, _config.getBuildInfo)())
    };
  }

  async getSessions() {
    const sessions = await sessionsListGuard.acquire(AppiumDriver.name, () => this.sessions);
    return _lodash.default.toPairs(sessions).map(([id, driver]) => {
      return {
        id,
        capabilities: driver.caps
      };
    });
  }

  printNewSessionAnnouncement(driver, caps) {
    const driverVersion = this.getDriverVersion(driver);
    const introString = driverVersion ? `Creating new ${driver.name} (v${driverVersion}) session` : `Creating new ${driver.name} session`;

    _logger.default.info(introString);

    _logger.default.info('Capabilities:');

    (0, _utils.inspectObject)(caps);
  }

  async createSession(jsonwpCaps, reqCaps, w3cCapabilities) {
    const {
      defaultCapabilities
    } = this.args;
    let protocol;
    let innerSessionId, dCaps;

    try {
      const parsedCaps = (0, _utils.parseCapsForInnerDriver)(jsonwpCaps, w3cCapabilities, this.desiredCapConstraints, defaultCapabilities);
      let {
        desiredCaps,
        processedJsonwpCapabilities,
        processedW3CCapabilities,
        error
      } = parsedCaps;
      protocol = parsedCaps.protocol;

      if (error) {
        throw error;
      }

      const InnerDriver = this.getDriverForCaps(desiredCaps);
      this.printNewSessionAnnouncement(InnerDriver, desiredCaps);

      if (this.args.sessionOverride) {
        const sessionIdsToDelete = await sessionsListGuard.acquire(AppiumDriver.name, () => _lodash.default.keys(this.sessions));

        if (sessionIdsToDelete.length) {
          _logger.default.info(`Session override is on. Deleting other ${sessionIdsToDelete.length} active session${sessionIdsToDelete.length ? '' : 's'}.`);

          try {
            await _bluebird.default.map(sessionIdsToDelete, id => this.deleteSession(id));
          } catch (ign) {}
        }
      }

      let runningDriversData, otherPendingDriversData;
      const d = new InnerDriver(this.args);

      if (this.args.relaxedSecurityEnabled) {
        _logger.default.info(`Applying relaxed security to '${InnerDriver.name}' as per server command line argument`);

        d.relaxedSecurityEnabled = true;
      }

      d.server = this.server;

      try {
        runningDriversData = await this.curSessionDataForDriver(InnerDriver);
      } catch (e) {
        throw new _appiumBaseDriver.errors.SessionNotCreatedError(e.message);
      }

      await pendingDriversGuard.acquire(AppiumDriver.name, () => {
        this.pendingDrivers[InnerDriver.name] = this.pendingDrivers[InnerDriver.name] || [];
        otherPendingDriversData = this.pendingDrivers[InnerDriver.name].map(drv => drv.driverData);
        this.pendingDrivers[InnerDriver.name].push(d);
      });

      try {
        [innerSessionId, dCaps] = await d.createSession(processedJsonwpCapabilities, reqCaps, processedW3CCapabilities, [...runningDriversData, ...otherPendingDriversData]);
        protocol = d.protocol;
        await sessionsListGuard.acquire(AppiumDriver.name, () => {
          this.sessions[innerSessionId] = d;
        });
      } finally {
        await pendingDriversGuard.acquire(AppiumDriver.name, () => {
          _lodash.default.pull(this.pendingDrivers[InnerDriver.name], d);
        });
      }

      this.attachUnexpectedShutdownHandler(d, innerSessionId);

      _logger.default.info(`New ${InnerDriver.name} session created successfully, session ` + `${innerSessionId} added to master session list`);

      d.startNewCommandTimeout();
    } catch (error) {
      return {
        protocol,
        error
      };
    }

    return {
      protocol,
      value: [innerSessionId, dCaps, protocol]
    };
  }

  async attachUnexpectedShutdownHandler(driver, innerSessionId) {
    try {
      await driver.onUnexpectedShutdown;
      throw new Error('Unexpected shutdown');
    } catch (e) {
      if (e instanceof _bluebird.default.CancellationError) {
        return;
      }

      _logger.default.warn(`Closing session, cause was '${e.message}'`);

      _logger.default.info(`Removing session ${innerSessionId} from our master session list`);

      await sessionsListGuard.acquire(AppiumDriver.name, () => {
        delete this.sessions[innerSessionId];
      });
    }
  }

  async curSessionDataForDriver(InnerDriver) {
    const sessions = await sessionsListGuard.acquire(AppiumDriver.name, () => this.sessions);

    const data = _lodash.default.values(sessions).filter(s => s.constructor.name === InnerDriver.name).map(s => s.driverData);

    for (let datum of data) {
      if (!datum) {
        throw new Error(`Problem getting session data for driver type ` + `${InnerDriver.name}; does it implement 'get ` + `driverData'?`);
      }
    }

    return data;
  }

  async deleteSession(sessionId) {
    let protocol;

    try {
      let otherSessionsData = null;
      let dstSession = null;
      await sessionsListGuard.acquire(AppiumDriver.name, () => {
        if (!this.sessions[sessionId]) {
          return;
        }

        const curConstructorName = this.sessions[sessionId].constructor.name;
        otherSessionsData = _lodash.default.toPairs(this.sessions).filter(([key, value]) => value.constructor.name === curConstructorName && key !== sessionId).map(([, value]) => value.driverData);
        dstSession = this.sessions[sessionId];
        protocol = dstSession.protocol;

        _logger.default.info(`Removing session ${sessionId} from our master session list`);

        delete this.sessions[sessionId];
      });
      return {
        protocol,
        value: await dstSession.deleteSession(sessionId, otherSessionsData)
      };
    } catch (e) {
      _logger.default.error(`Had trouble ending session ${sessionId}: ${e.message}`);

      return {
        protocol,
        error: e
      };
    }
  }

  async executeCommand(cmd, ...args) {
    if (cmd === 'getStatus') {
      return await this.getStatus();
    }

    if (isAppiumDriverCommand(cmd)) {
      return await super.executeCommand(cmd, ...args);
    }

    const sessionId = _lodash.default.last(args);

    const dstSession = await sessionsListGuard.acquire(AppiumDriver.name, () => this.sessions[sessionId]);

    if (!dstSession) {
      throw new Error(`The session with id '${sessionId}' does not exist`);
    }

    let res = {
      protocol: dstSession.protocol
    };

    try {
      res.value = await dstSession.executeCommand(cmd, ...args);
    } catch (e) {
      res.error = e;
    }

    return res;
  }

  proxyActive(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession && _lodash.default.isFunction(dstSession.proxyActive) && dstSession.proxyActive(sessionId);
  }

  getProxyAvoidList(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession ? dstSession.getProxyAvoidList() : [];
  }

  canProxy(sessionId) {
    const dstSession = this.sessions[sessionId];
    return dstSession && dstSession.canProxy(sessionId);
  }

}

exports.AppiumDriver = AppiumDriver;

function isAppiumDriverCommand(cmd) {
  return !(0, _appiumBaseDriver.isSessionCommand)(cmd) || cmd === "deleteSession";
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hcHBpdW0uanMiXSwibmFtZXMiOlsiUExBVEZPUk1TIiwiRkFLRSIsIkFORFJPSUQiLCJJT1MiLCJXSU5ET1dTIiwiTUFDIiwiVElaRU4iLCJBVVRPTUFUSU9OX05BTUVTIiwiQVBQSVVNIiwiU0VMRU5EUk9JRCIsIlVJQVVUT01BVE9SMiIsIlVJQVVUT01BVE9SMSIsIlhDVUlURVNUIiwiWU9VSUVOR0lORSIsIkVTUFJFU1NPIiwiSU5TVFJVTUVOVFMiLCJEUklWRVJfTUFQIiwiU2VsZW5kcm9pZERyaXZlciIsImRyaXZlckNsYXNzIiwiYXV0b21hdGlvbk5hbWUiLCJ2ZXJzaW9uIiwiQW5kcm9pZFVpYXV0b21hdG9yMkRyaXZlciIsIlhDVUlUZXN0RHJpdmVyIiwiWW91aUVuZ2luZURyaXZlciIsIkZha2VEcml2ZXIiLCJBbmRyb2lkRHJpdmVyIiwiSW9zRHJpdmVyIiwiV2luZG93c0RyaXZlciIsIk1hY0RyaXZlciIsIkVzcHJlc3NvRHJpdmVyIiwiVGl6ZW5Ecml2ZXIiLCJQTEFURk9STVNfTUFQIiwiY2FwcyIsInBsYXRmb3JtVmVyc2lvbiIsInNlbXZlciIsInZhbGlkIiwiY29lcmNlIiwibG9nIiwid2FybiIsImluZm8iLCJzYXRpc2ZpZXMiLCJkZXNpcmVkQ2FwYWJpbGl0eUNvbnN0cmFpbnRzIiwicHJlc2VuY2UiLCJpc1N0cmluZyIsImluY2x1c2lvbkNhc2VJbnNlbnNpdGl2ZSIsIl8iLCJ2YWx1ZXMiLCJwbGF0Zm9ybU5hbWUiLCJrZXlzIiwic2Vzc2lvbnNMaXN0R3VhcmQiLCJBc3luY0xvY2siLCJwZW5kaW5nRHJpdmVyc0d1YXJkIiwiQXBwaXVtRHJpdmVyIiwiQmFzZURyaXZlciIsImNvbnN0cnVjdG9yIiwiYXJncyIsImRlc2lyZWRDYXBDb25zdHJhaW50cyIsIm5ld0NvbW1hbmRUaW1lb3V0TXMiLCJPYmplY3QiLCJhc3NpZ24iLCJzZXNzaW9ucyIsInBlbmRpbmdEcml2ZXJzIiwiaXNDb21tYW5kc1F1ZXVlRW5hYmxlZCIsInNlc3Npb25FeGlzdHMiLCJzZXNzaW9uSWQiLCJkc3RTZXNzaW9uIiwiZHJpdmVyRm9yU2Vzc2lvbiIsImdldERyaXZlckZvckNhcHMiLCJFcnJvciIsInRvTG93ZXJDYXNlIiwidG9Mb3dlciIsImRyaXZlclNlbGVjdG9yIiwibXNnIiwiZ2V0RHJpdmVyVmVyc2lvbiIsImRyaXZlciIsIm5hbWUiLCJnZXRTdGF0dXMiLCJidWlsZCIsImNsb25lIiwiZ2V0U2Vzc2lvbnMiLCJhY3F1aXJlIiwidG9QYWlycyIsIm1hcCIsImlkIiwiY2FwYWJpbGl0aWVzIiwicHJpbnROZXdTZXNzaW9uQW5ub3VuY2VtZW50IiwiZHJpdmVyVmVyc2lvbiIsImludHJvU3RyaW5nIiwiY3JlYXRlU2Vzc2lvbiIsImpzb253cENhcHMiLCJyZXFDYXBzIiwidzNjQ2FwYWJpbGl0aWVzIiwiZGVmYXVsdENhcGFiaWxpdGllcyIsInByb3RvY29sIiwiaW5uZXJTZXNzaW9uSWQiLCJkQ2FwcyIsInBhcnNlZENhcHMiLCJkZXNpcmVkQ2FwcyIsInByb2Nlc3NlZEpzb253cENhcGFiaWxpdGllcyIsInByb2Nlc3NlZFczQ0NhcGFiaWxpdGllcyIsImVycm9yIiwiSW5uZXJEcml2ZXIiLCJzZXNzaW9uT3ZlcnJpZGUiLCJzZXNzaW9uSWRzVG9EZWxldGUiLCJsZW5ndGgiLCJCIiwiZGVsZXRlU2Vzc2lvbiIsImlnbiIsInJ1bm5pbmdEcml2ZXJzRGF0YSIsIm90aGVyUGVuZGluZ0RyaXZlcnNEYXRhIiwiZCIsInJlbGF4ZWRTZWN1cml0eUVuYWJsZWQiLCJzZXJ2ZXIiLCJjdXJTZXNzaW9uRGF0YUZvckRyaXZlciIsImUiLCJlcnJvcnMiLCJTZXNzaW9uTm90Q3JlYXRlZEVycm9yIiwibWVzc2FnZSIsImRydiIsImRyaXZlckRhdGEiLCJwdXNoIiwicHVsbCIsImF0dGFjaFVuZXhwZWN0ZWRTaHV0ZG93bkhhbmRsZXIiLCJzdGFydE5ld0NvbW1hbmRUaW1lb3V0IiwidmFsdWUiLCJvblVuZXhwZWN0ZWRTaHV0ZG93biIsIkNhbmNlbGxhdGlvbkVycm9yIiwiZGF0YSIsImZpbHRlciIsInMiLCJkYXR1bSIsIm90aGVyU2Vzc2lvbnNEYXRhIiwiY3VyQ29uc3RydWN0b3JOYW1lIiwia2V5IiwiZXhlY3V0ZUNvbW1hbmQiLCJjbWQiLCJpc0FwcGl1bURyaXZlckNvbW1hbmQiLCJsYXN0IiwicmVzIiwicHJveHlBY3RpdmUiLCJpc0Z1bmN0aW9uIiwiZ2V0UHJveHlBdm9pZExpc3QiLCJjYW5Qcm94eSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxTQUFTLEdBQUc7QUFDaEJDLEVBQUFBLElBQUksRUFBRSxNQURVO0FBRWhCQyxFQUFBQSxPQUFPLEVBQUUsU0FGTztBQUdoQkMsRUFBQUEsR0FBRyxFQUFFLEtBSFc7QUFJaEJDLEVBQUFBLE9BQU8sRUFBRSxTQUpPO0FBS2hCQyxFQUFBQSxHQUFHLEVBQUUsS0FMVztBQU1oQkMsRUFBQUEsS0FBSyxFQUFFO0FBTlMsQ0FBbEI7QUFTQSxNQUFNQyxnQkFBZ0IsR0FBRztBQUN2QkMsRUFBQUEsTUFBTSxFQUFFLFFBRGU7QUFFdkJDLEVBQUFBLFVBQVUsRUFBRSxZQUZXO0FBR3ZCQyxFQUFBQSxZQUFZLEVBQUUsY0FIUztBQUl2QkMsRUFBQUEsWUFBWSxFQUFFLGNBSlM7QUFLdkJDLEVBQUFBLFFBQVEsRUFBRSxVQUxhO0FBTXZCQyxFQUFBQSxVQUFVLEVBQUUsWUFOVztBQU92QkMsRUFBQUEsUUFBUSxFQUFFLFVBUGE7QUFRdkJSLEVBQUFBLEtBQUssRUFBRSxPQVJnQjtBQVN2QkwsRUFBQUEsSUFBSSxFQUFFLE1BVGlCO0FBVXZCYyxFQUFBQSxXQUFXLEVBQUU7QUFWVSxDQUF6QjtBQVlBLE1BQU1DLFVBQVUsR0FBRztBQUNqQkMsRUFBQUEsZ0JBQWdCLEVBQUU7QUFD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LENBQTdEO0FBQ0Q7O0FBRUQ2RSxFQUFBQSxpQkFBaUIsQ0FBRTdFLFNBQUYsRUFBYTtBQUM1QixVQUFNQyxVQUFVLEdBQUcsS0FBS0wsUUFBTCxDQUFjSSxTQUFkLENBQW5CO0FBQ0EsV0FBT0MsVUFBVSxHQUFHQSxVQUFVLENBQUM0RSxpQkFBWCxFQUFILEdBQW9DLEVBQXJEO0FBQ0Q7O0FBRURDLEVBQUFBLFFBQVEsQ0FBRTlFLFNBQUYsRUFBYTtBQUNuQixVQUFNQyxVQUFVLEdBQUcsS0FBS0wsUUFBTCxDQUFjSSxTQUFkLENBQW5CO0FBQ0EsV0FBT0MsVUFBVSxJQUFJQSxVQUFVLENBQUM2RSxRQUFYLENBQW9COUUsU0FBcEIsQ0FBckI7QUFDRDs7QUE1VG1DOzs7O0FBaVV0QyxTQUFTd0UscUJBQVQsQ0FBZ0NELEdBQWhDLEVBQXFDO0FBQ25DLFNBQU8sQ0FBQyx3Q0FBaUJBLEdBQWpCLENBQUQsSUFBMEJBLEdBQUcsS0FBSyxlQUF6QztBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgZ2V0QnVpbGRJbmZvLCB1cGRhdGVCdWlsZEluZm8gfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgeyBCYXNlRHJpdmVyLCBlcnJvcnMsIGlzU2Vzc2lvbkNvbW1hbmQgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgRmFrZURyaXZlciB9IGZyb20gJ2FwcGl1bS1mYWtlLWRyaXZlcic7XG5pbXBvcnQgeyBBbmRyb2lkRHJpdmVyIH0gZnJvbSAnYXBwaXVtLWFuZHJvaWQtZHJpdmVyJztcbmltcG9ydCB7IElvc0RyaXZlciB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IEFuZHJvaWRVaWF1dG9tYXRvcjJEcml2ZXIgfSBmcm9tICdhcHBpdW0tdWlhdXRvbWF0b3IyLWRyaXZlcic7XG5pbXBvcnQgeyBTZWxlbmRyb2lkRHJpdmVyIH0gZnJvbSAnYXBwaXVtLXNlbGVuZHJvaWQtZHJpdmVyJztcbmltcG9ydCB7IFhDVUlUZXN0RHJpdmVyIH0gZnJvbSAnYXBwaXVtLXhjdWl0ZXN0LWRyaXZlcic7XG5pbXBvcnQgeyBZb3VpRW5naW5lRHJpdmVyIH0gZnJvbSAnYXBwaXVtLXlvdWllbmdpbmUtZHJpdmVyJztcbmltcG9ydCB7IFdpbmRvd3NEcml2ZXIgfSBmcm9tICdhcHBpdW0td2luZG93cy1kcml2ZXInO1xuaW1wb3J0IHsgTWFjRHJpdmVyIH0gZnJvbSAnYXBwaXVtLW1hYy1kcml2ZXInO1xuaW1wb3J0IHsgRXNwcmVzc29Ecml2ZXIgfSBmcm9tICdhcHBpdW0tZXNwcmVzc28tZHJpdmVyJztcbmltcG9ydCB7IFRpemVuRHJpdmVyIH0gZnJvbSAnYXBwaXVtLXRpemVuLWRyaXZlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IHsgaW5zcGVjdE9iamVjdCwgcGFyc2VDYXBzRm9ySW5uZXJEcml2ZXIsIGdldFBhY2thZ2VWZXJzaW9uIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cbmNvbnN0IFBMQVRGT1JNUyA9IHtcbiAgRkFLRTogJ2Zha2UnLFxuICBBTkRST0lEOiAnYW5kcm9pZCcsXG4gIElPUzogJ2lvcycsXG4gIFdJTkRPV1M6ICd3aW5kb3dzJyxcbiAgTUFDOiAnbWFjJyxcbiAgVElaRU46ICd0aXplbicsXG59O1xuXG5jb25zdCBBVVRPTUFUSU9OX05BTUVTID0ge1xuICBBUFBJVU06ICdBcHBpdW0nLFxuICBTRUxFTkRST0lEOiAnU2VsZW5kcm9pZCcsXG4gIFVJQVVUT01BVE9SMjogJ1VpQXV0b21hdG9yMicsXG4gIFVJQVVUT01BVE9SMTogJ1VpQXV0b21hdG9yMScsXG4gIFhDVUlURVNUOiAnWENVSVRlc3QnLFxuICBZT1VJRU5HSU5FOiAnWW91aUVuZ2luZScsXG4gIEVTUFJFU1NPOiAnRXNwcmVzc28nLFxuICBUSVpFTjogJ1RpemVuJyxcbiAgRkFLRTogJ0Zha2UnLFxuICBJTlNUUlVNRU5UUzogJ0luc3RydW1lbnRzJyxcbn07XG5jb25zdCBEUklWRVJfTUFQID0ge1xuICBTZWxlbmRyb2lkRHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IFNlbGVuZHJvaWREcml2ZXIsXG4gICAgYXV0b21hdGlvbk5hbWU6IEFVVE9NQVRJT05fTkFNRVMuU0VMRU5EUk9JRCxcbiAgICB2ZXJzaW9uOiBnZXRQYWNrYWdlVmVyc2lvbignYXBwaXVtLXNlbGVuZHJvaWQtZHJpdmVyJyksXG4gIH0sXG4gIEFuZHJvaWRVaWF1dG9tYXRvcjJEcml2ZXI6IHtcbiAgICBkcml2ZXJDbGFzczogQW5kcm9pZFVpYXV0b21hdG9yMkRyaXZlcixcbiAgICBhdXRvbWF0aW9uTmFtZTogQVVUT01BVElPTl9OQU1FUy5VSUFVVE9NQVRPUjIsXG4gICAgdmVyc2lvbjogZ2V0UGFja2FnZVZlcnNpb24oJ2FwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyJyksXG4gIH0sXG4gIFhDVUlUZXN0RHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IFhDVUlUZXN0RHJpdmVyLFxuICAgIGF1dG9tYXRpb25OYW1lOiBBVVRPTUFUSU9OX05BTUVTLlhDVUlURVNULFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0teGN1aXRlc3QtZHJpdmVyJyksXG4gIH0sXG4gIFlvdWlFbmdpbmVEcml2ZXI6IHtcbiAgICBkcml2ZXJDbGFzczogWW91aUVuZ2luZURyaXZlcixcbiAgICBhdXRvbWF0aW9uTmFtZTogQVVUT01BVElPTl9OQU1FUy5ZT1VJRU5HSU5FLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0teW91aWVuZ2luZS1kcml2ZXInKSxcbiAgfSxcbiAgRmFrZURyaXZlcjoge1xuICAgIGRyaXZlckNsYXNzOiBGYWtlRHJpdmVyLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0tZmFrZS1kcml2ZXInKSxcbiAgfSxcbiAgQW5kcm9pZERyaXZlcjoge1xuICAgIGRyaXZlckNsYXNzOiBBbmRyb2lkRHJpdmVyLFxuICAgIGF1dG9tYXRpb25OYW1lOiBBVVRPTUFUSU9OX05BTUVTLlVJQVVUT01BVE9SMSxcbiAgICB2ZXJzaW9uOiBnZXRQYWNrYWdlVmVyc2lvbignYXBwaXVtLWFuZHJvaWQtZHJpdmVyJyksXG4gIH0sXG4gIElvc0RyaXZlcjoge1xuICAgIGRyaXZlckNsYXNzOiBJb3NEcml2ZXIsXG4gICAgYXV0b21hdGlvbk5hbWU6IEFVVE9NQVRJT05fTkFNRVMuSU5TVFJVTUVOVFMsXG4gICAgdmVyc2lvbjogZ2V0UGFja2FnZVZlcnNpb24oJ2FwcGl1bS1pb3MtZHJpdmVyJyksXG4gIH0sXG4gIFdpbmRvd3NEcml2ZXI6IHtcbiAgICBkcml2ZXJDbGFzczogV2luZG93c0RyaXZlcixcbiAgICB2ZXJzaW9uOiBnZXRQYWNrYWdlVmVyc2lvbignYXBwaXVtLXdpbmRvd3MtZHJpdmVyJyksXG4gIH0sXG4gIE1hY0RyaXZlcjoge1xuICAgIGRyaXZlckNsYXNzOiBNYWNEcml2ZXIsXG4gICAgdmVyc2lvbjogZ2V0UGFja2FnZVZlcnNpb24oJ2FwcGl1bS1tYWMtZHJpdmVyJyksXG4gIH0sXG4gIEVzcHJlc3NvRHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IEVzcHJlc3NvRHJpdmVyLFxuICAgIGF1dG9tYXRpb25OYW1lOiBBVVRPTUFUSU9OX05BTUVTLkVTUFJFU1NPLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0tZXNwcmVzc28tZHJpdmVyJyksXG4gIH0sXG4gIFRpemVuRHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IFRpemVuRHJpdmVyLFxuICAgIGF1dG9tYXRpb25OYW1lOiBBVVRPTUFUSU9OX05BTUVTLlRJWkVOLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0tdGl6ZW4tZHJpdmVyJyksXG4gIH0sXG59O1xuXG5jb25zdCBQTEFURk9STVNfTUFQID0ge1xuICBbUExBVEZPUk1TLkZBS0VdOiAoKSA9PiBGYWtlRHJpdmVyLFxuICBbUExBVEZPUk1TLkFORFJPSURdOiAoY2FwcykgPT4ge1xuICAgIGNvbnN0IHBsYXRmb3JtVmVyc2lvbiA9IHNlbXZlci52YWxpZChzZW12ZXIuY29lcmNlKGNhcHMucGxhdGZvcm1WZXJzaW9uKSk7XG4gICAgbG9nLndhcm4oYERlcHJlY2F0aW9uV2FybmluZzogJ2F1dG9tYXRpb25OYW1lJyBjYXBhYmlsaXR5IHdhcyBub3QgcHJvdmlkZWQuIGAgK1xuICAgICAgYEZ1dHVyZSB2ZXJzaW9ucyBvZiBBcHBpdW0gd2lsbCByZXF1aXJlICdhdXRvbWF0aW9uTmFtZScgY2FwYWJpbGl0eSB0byBiZSBzZXQgZm9yIEFuZHJvaWQgc2Vzc2lvbnMuYCk7XG4gICAgbG9nLmluZm8oYFNldHRpbmcgYXV0b21hdGlvbiB0byAnJHtBVVRPTUFUSU9OX05BTUVTLlVJQVVUT01BVE9SMX0nLiBgKTtcbiAgICBpZiAocGxhdGZvcm1WZXJzaW9uICYmIHNlbXZlci5zYXRpc2ZpZXMocGxhdGZvcm1WZXJzaW9uLCAnPj02LjAuMCcpKSB7XG4gICAgICBsb2cud2FybihgQ29uc2lkZXIgc2V0dGluZyAnYXV0b21hdGlvbk5hbWUnIGNhcGFiaWxpdHkgdG8gJyR7QVVUT01BVElPTl9OQU1FUy5VSUFVVE9NQVRPUjJ9JyBgICtcbiAgICAgICAgJ29uIEFuZHJvaWQgPj0gNiwgc2luY2UgVUlBdXRvbWF0b3IxIGZyYW1ld29yayAnICtcbiAgICAgICAgJ2lzIG5vdCBtYWludGFpbmVkIGFueW1vcmUgYnkgdGhlIE9TIHZlbmRvci4nKTtcbiAgICB9XG5cbiAgICByZXR1cm4gQW5kcm9pZERyaXZlcjtcbiAgfSxcbiAgW1BMQVRGT1JNUy5JT1NdOiAoY2FwcykgPT4ge1xuICAgIGNvbnN0IHBsYXRmb3JtVmVyc2lvbiA9IHNlbXZlci52YWxpZChzZW12ZXIuY29lcmNlKGNhcHMucGxhdGZvcm1WZXJzaW9uKSk7XG4gICAgbG9nLndhcm4oYERlcHJlY2F0aW9uV2FybmluZzogJ2F1dG9tYXRpb25OYW1lJyBjYXBhYmlsaXR5IHdhcyBub3QgcHJvdmlkZWQuIGAgK1xuICAgICAgYEZ1dHVyZSB2ZXJzaW9ucyBvZiBBcHBpdW0gd2lsbCByZXF1aXJlICdhdXRvbWF0aW9uTmFtZScgY2FwYWJpbGl0eSB0byBiZSBzZXQgZm9yIGlPUyBzZXNzaW9ucy5gKTtcbiAgICBpZiAocGxhdGZvcm1WZXJzaW9uICYmIHNlbXZlci5zYXRpc2ZpZXMocGxhdGZvcm1WZXJzaW9uLCAnPj0xMC4wLjAnKSkge1xuICAgICAgbG9nLmluZm8oXCJSZXF1ZXN0ZWQgaU9TIHN1cHBvcnQgd2l0aCB2ZXJzaW9uID49IDEwLCBcIiArXG4gICAgICAgIGB1c2luZyAnJHtBVVRPTUFUSU9OX05BTUVTLlhDVUlURVNUfScgYCArXG4gICAgICAgIFwiZHJpdmVyIGluc3RlYWQgb2YgVUlBdXRvbWF0aW9uLWJhc2VkIGRyaXZlciwgc2luY2UgdGhlIFwiICtcbiAgICAgICAgXCJsYXR0ZXIgaXMgdW5zdXBwb3J0ZWQgb24gaU9TIDEwIGFuZCB1cC5cIik7XG4gICAgICByZXR1cm4gWENVSVRlc3REcml2ZXI7XG4gICAgfVxuXG4gICAgcmV0dXJuIElvc0RyaXZlcjtcbiAgfSxcbiAgW1BMQVRGT1JNUy5XSU5ET1dTXTogKCkgPT4gV2luZG93c0RyaXZlcixcbiAgW1BMQVRGT1JNUy5NQUNdOiAoKSA9PiBNYWNEcml2ZXIsXG4gIFtQTEFURk9STVMuVElaRU5dOiAoKSA9PiBUaXplbkRyaXZlcixcbn07XG5cbmNvbnN0IGRlc2lyZWRDYXBhYmlsaXR5Q29uc3RyYWludHMgPSB7XG4gIGF1dG9tYXRpb25OYW1lOiB7XG4gICAgcHJlc2VuY2U6IGZhbHNlLFxuICAgIGlzU3RyaW5nOiB0cnVlLFxuICAgIGluY2x1c2lvbkNhc2VJbnNlbnNpdGl2ZTogXy52YWx1ZXMoQVVUT01BVElPTl9OQU1FUyksXG4gIH0sXG4gIHBsYXRmb3JtTmFtZToge1xuICAgIHByZXNlbmNlOiB0cnVlLFxuICAgIGlzU3RyaW5nOiB0cnVlLFxuICAgIGluY2x1c2lvbkNhc2VJbnNlbnNpdGl2ZTogXy5rZXlzKFBMQVRGT1JNU19NQVApLFxuICB9LFxufTtcblxuY29uc3Qgc2Vzc2lvbnNMaXN0R3VhcmQgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBwZW5kaW5nRHJpdmVyc0d1YXJkID0gbmV3IEFzeW5jTG9jaygpO1xuXG5jbGFzcyBBcHBpdW1Ecml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgY29uc3RydWN0b3IgKGFyZ3MpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSBkZXNpcmVkQ2FwYWJpbGl0eUNvbnN0cmFpbnRzO1xuXG4gICAgLy8gdGhlIG1haW4gQXBwaXVtIERyaXZlciBoYXMgbm8gbmV3IGNvbW1hbmQgdGltZW91dFxuICAgIHRoaXMubmV3Q29tbWFuZFRpbWVvdXRNcyA9IDA7XG5cbiAgICB0aGlzLmFyZ3MgPSBPYmplY3QuYXNzaWduKHt9LCBhcmdzKTtcblxuICAgIC8vIEFjY2VzcyB0byBzZXNzaW9ucyBsaXN0IG11c3QgYmUgZ3VhcmRlZCB3aXRoIGEgU2VtYXBob3JlLCBiZWNhdXNlXG4gICAgLy8gaXQgbWlnaHQgYmUgY2hhbmdlZCBieSBvdGhlciBhc3luYyBjYWxscyBhdCBhbnkgdGltZVxuICAgIC8vIEl0IGlzIG5vdCByZWNvbW1lbmRlZCB0byBhY2Nlc3MgdGhpcyBwcm9wZXJ0eSBkaXJlY3RseSBmcm9tIHRoZSBvdXRzaWRlXG4gICAgdGhpcy5zZXNzaW9ucyA9IHt9O1xuXG4gICAgLy8gQWNjZXNzIHRvIHBlbmRpbmcgZHJpdmVycyBsaXN0IG11c3QgYmUgZ3VhcmRlZCB3aXRoIGEgU2VtYXBob3JlLCBiZWNhdXNlXG4gICAgLy8gaXQgbWlnaHQgYmUgY2hhbmdlZCBieSBvdGhlciBhc3luYyBjYWxscyBhdCBhbnkgdGltZVxuICAgIC8vIEl0IGlzIG5vdCByZWNvbW1lbmRlZCB0byBhY2Nlc3MgdGhpcyBwcm9wZXJ0eSBkaXJlY3RseSBmcm9tIHRoZSBvdXRzaWRlXG4gICAgdGhpcy5wZW5kaW5nRHJpdmVycyA9IHt9O1xuXG4gICAgLy8gYWxsb3cgdGhpcyB0byBoYXBwZW4gaW4gdGhlIGJhY2tncm91bmQsIHNvIG5vIGBhd2FpdGBcbiAgICB1cGRhdGVCdWlsZEluZm8oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWwgY29tbWFuZHMgcXVldWVpbmcgZm9yIHRoZSB1bWJyZWxsYSBBcHBpdW0gZHJpdmVyXG4gICAqL1xuICBnZXQgaXNDb21tYW5kc1F1ZXVlRW5hYmxlZCAoKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgc2Vzc2lvbkV4aXN0cyAoc2Vzc2lvbklkKSB7XG4gICAgY29uc3QgZHN0U2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICByZXR1cm4gZHN0U2Vzc2lvbiAmJiBkc3RTZXNzaW9uLnNlc3Npb25JZCAhPT0gbnVsbDtcbiAgfVxuXG4gIGRyaXZlckZvclNlc3Npb24gKHNlc3Npb25JZCkge1xuICAgIHJldHVybiB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF07XG4gIH1cblxuICBnZXREcml2ZXJGb3JDYXBzIChjYXBzKSB7XG4gICAgaWYgKCFfLmlzU3RyaW5nKGNhcHMucGxhdGZvcm1OYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiWW91IG11c3QgaW5jbHVkZSBhIHBsYXRmb3JtTmFtZSBjYXBhYmlsaXR5XCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHBsYXRmb3JtTmFtZSA9IGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAvLyB3ZSBkb24ndCBuZWNlc3NhcmlseSBoYXZlIGFuIGBhdXRvbWF0aW9uTmFtZWAgY2FwYWJpbGl0eSxcbiAgICBpZiAoXy5pc1N0cmluZyhjYXBzLmF1dG9tYXRpb25OYW1lKSkge1xuICAgICAgZm9yIChjb25zdCB7YXV0b21hdGlvbk5hbWUsIGRyaXZlckNsYXNzfSBvZiBfLnZhbHVlcyhEUklWRVJfTUFQKSkge1xuICAgICAgICBpZiAoXy50b0xvd2VyKGF1dG9tYXRpb25OYW1lKSA9PT0gY2Fwcy5hdXRvbWF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgcmV0dXJuIGRyaXZlckNsYXNzO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgZHJpdmVyU2VsZWN0b3IgPSBQTEFURk9STVNfTUFQW3BsYXRmb3JtTmFtZV07XG4gICAgaWYgKGRyaXZlclNlbGVjdG9yKSB7XG4gICAgICByZXR1cm4gZHJpdmVyU2VsZWN0b3IoY2Fwcyk7XG4gICAgfVxuXG4gICAgY29uc3QgbXNnID0gXy5pc1N0cmluZyhjYXBzLmF1dG9tYXRpb25OYW1lKVxuICAgICAgPyBgQ291bGQgbm90IGZpbmQgYSBkcml2ZXIgZm9yIGF1dG9tYXRpb25OYW1lICcke2NhcHMuYXV0b21hdGlvbk5hbWV9JyBhbmQgcGxhdGZvcm1OYW1lIGAgK1xuICAgICAgICAgICAgYCcke2NhcHMucGxhdGZvcm1OYW1lfScuYFxuICAgICAgOiBgQ291bGQgbm90IGZpbmQgYSBkcml2ZXIgZm9yIHBsYXRmb3JtTmFtZSAnJHtjYXBzLnBsYXRmb3JtTmFtZX0nLmA7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke21zZ30gUGxlYXNlIGNoZWNrIHlvdXIgZGVzaXJlZCBjYXBhYmlsaXRpZXMuYCk7XG4gIH1cblxuICBnZXREcml2ZXJWZXJzaW9uIChkcml2ZXIpIHtcbiAgICBjb25zdCB7dmVyc2lvbn0gPSBEUklWRVJfTUFQW2RyaXZlci5uYW1lXSB8fCB7fTtcbiAgICBpZiAodmVyc2lvbikge1xuICAgICAgcmV0dXJuIHZlcnNpb247XG4gICAgfVxuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZ2V0IHZlcnNpb24gb2YgZHJpdmVyICcke2RyaXZlci5uYW1lfSdgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIHJldHVybiB7XG4gICAgICBidWlsZDogXy5jbG9uZShnZXRCdWlsZEluZm8oKSksXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFNlc3Npb25zICgpIHtcbiAgICBjb25zdCBzZXNzaW9ucyA9IGF3YWl0IHNlc3Npb25zTGlzdEd1YXJkLmFjcXVpcmUoQXBwaXVtRHJpdmVyLm5hbWUsICgpID0+IHRoaXMuc2Vzc2lvbnMpO1xuICAgIHJldHVybiBfLnRvUGFpcnMoc2Vzc2lvbnMpXG4gICAgICAgIC5tYXAoKFtpZCwgZHJpdmVyXSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7aWQsIGNhcGFiaWxpdGllczogZHJpdmVyLmNhcHN9O1xuICAgICAgICB9KTtcbiAgfVxuXG4gIHByaW50TmV3U2Vzc2lvbkFubm91bmNlbWVudCAoZHJpdmVyLCBjYXBzKSB7XG4gICAgY29uc3QgZHJpdmVyVmVyc2lvbiA9IHRoaXMuZ2V0RHJpdmVyVmVyc2lvbihkcml2ZXIpO1xuICAgIGNvbnN0IGludHJvU3RyaW5nID0gZHJpdmVyVmVyc2lvblxuICAgICAgPyBgQ3JlYXRpbmcgbmV3ICR7ZHJpdmVyLm5hbWV9ICh2JHtkcml2ZXJWZXJzaW9ufSkgc2Vzc2lvbmBcbiAgICAgIDogYENyZWF0aW5nIG5ldyAke2RyaXZlci5uYW1lfSBzZXNzaW9uYDtcbiAgICBsb2cuaW5mbyhpbnRyb1N0cmluZyk7XG4gICAgbG9nLmluZm8oJ0NhcGFiaWxpdGllczonKTtcbiAgICBpbnNwZWN0T2JqZWN0KGNhcHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBzZXNzaW9uXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBqc29ud3BDYXBzIEpTT05XUCBmb3JtYXR0ZWQgZGVzaXJlZCBjYXBhYmlsaXRpZXNcbiAgICogQHBhcmFtIHtPYmplY3R9IHJlcUNhcHMgUmVxdWlyZWQgY2FwYWJpbGl0aWVzIChKU09OV1Agc3RhbmRhcmQpXG4gICAqIEBwYXJhbSB7T2JqZWN0fSB3M2NDYXBhYmlsaXRpZXMgVzNDIGNhcGFiaWxpdGllc1xuICAgKiBAcmV0dXJuIHtBcnJheX0gVW5pcXVlIHNlc3Npb24gSUQgYW5kIGNhcGFiaWxpdGllc1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbiAoanNvbndwQ2FwcywgcmVxQ2FwcywgdzNjQ2FwYWJpbGl0aWVzKSB7XG4gICAgY29uc3Qge2RlZmF1bHRDYXBhYmlsaXRpZXN9ID0gdGhpcy5hcmdzO1xuICAgIGxldCBwcm90b2NvbDtcbiAgICBsZXQgaW5uZXJTZXNzaW9uSWQsIGRDYXBzO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFBhcnNlIHRoZSBjYXBzIGludG8gYSBmb3JtYXQgdGhhdCB0aGUgSW5uZXJEcml2ZXIgd2lsbCBhY2NlcHRcbiAgICAgIGNvbnN0IHBhcnNlZENhcHMgPSBwYXJzZUNhcHNGb3JJbm5lckRyaXZlcihcbiAgICAgICAganNvbndwQ2FwcyxcbiAgICAgICAgdzNjQ2FwYWJpbGl0aWVzLFxuICAgICAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyxcbiAgICAgICAgZGVmYXVsdENhcGFiaWxpdGllc1xuICAgICAgKTtcblxuICAgICAgbGV0IHtkZXNpcmVkQ2FwcywgcHJvY2Vzc2VkSnNvbndwQ2FwYWJpbGl0aWVzLCBwcm9jZXNzZWRXM0NDYXBhYmlsaXRpZXMsIGVycm9yfSA9IHBhcnNlZENhcHM7XG4gICAgICBwcm90b2NvbCA9IHBhcnNlZENhcHMucHJvdG9jb2w7XG5cbiAgICAgIC8vIElmIHRoZSBwYXJzaW5nIG9mIHRoZSBjYXBzIHByb2R1Y2VkIGFuIGVycm9yLCB0aHJvdyBpdCBpbiBoZXJlXG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IElubmVyRHJpdmVyID0gdGhpcy5nZXREcml2ZXJGb3JDYXBzKGRlc2lyZWRDYXBzKTtcbiAgICAgIHRoaXMucHJpbnROZXdTZXNzaW9uQW5ub3VuY2VtZW50KElubmVyRHJpdmVyLCBkZXNpcmVkQ2Fwcyk7XG5cbiAgICAgIGlmICh0aGlzLmFyZ3Muc2Vzc2lvbk92ZXJyaWRlKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb25JZHNUb0RlbGV0ZSA9IGF3YWl0IHNlc3Npb25zTGlzdEd1YXJkLmFjcXVpcmUoQXBwaXVtRHJpdmVyLm5hbWUsICgpID0+IF8ua2V5cyh0aGlzLnNlc3Npb25zKSk7XG4gICAgICAgIGlmIChzZXNzaW9uSWRzVG9EZWxldGUubGVuZ3RoKSB7XG4gICAgICAgICAgbG9nLmluZm8oYFNlc3Npb24gb3ZlcnJpZGUgaXMgb24uIERlbGV0aW5nIG90aGVyICR7c2Vzc2lvbklkc1RvRGVsZXRlLmxlbmd0aH0gYWN0aXZlIHNlc3Npb24ke3Nlc3Npb25JZHNUb0RlbGV0ZS5sZW5ndGggPyAnJyA6ICdzJ30uYCk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IEIubWFwKHNlc3Npb25JZHNUb0RlbGV0ZSwgKGlkKSA9PiB0aGlzLmRlbGV0ZVNlc3Npb24oaWQpKTtcbiAgICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbGV0IHJ1bm5pbmdEcml2ZXJzRGF0YSwgb3RoZXJQZW5kaW5nRHJpdmVyc0RhdGE7XG4gICAgICBjb25zdCBkID0gbmV3IElubmVyRHJpdmVyKHRoaXMuYXJncyk7XG4gICAgICBpZiAodGhpcy5hcmdzLnJlbGF4ZWRTZWN1cml0eUVuYWJsZWQpIHtcbiAgICAgICAgbG9nLmluZm8oYEFwcGx5aW5nIHJlbGF4ZWQgc2VjdXJpdHkgdG8gJyR7SW5uZXJEcml2ZXIubmFtZX0nIGFzIHBlciBzZXJ2ZXIgY29tbWFuZCBsaW5lIGFyZ3VtZW50YCk7XG4gICAgICAgIGQucmVsYXhlZFNlY3VyaXR5RW5hYmxlZCA9IHRydWU7XG4gICAgICB9XG4gICAgICAvLyBUaGlzIGFzc2lnbm1lbnQgaXMgcmVxdWlyZWQgZm9yIGNvcnJlY3Qgd2ViIHNvY2tldHMgZnVuY3Rpb25hbGl0eSBpbnNpZGUgdGhlIGRyaXZlclxuICAgICAgZC5zZXJ2ZXIgPSB0aGlzLnNlcnZlcjtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJ1bm5pbmdEcml2ZXJzRGF0YSA9IGF3YWl0IHRoaXMuY3VyU2Vzc2lvbkRhdGFGb3JEcml2ZXIoSW5uZXJEcml2ZXIpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IoZS5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IHBlbmRpbmdEcml2ZXJzR3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4ge1xuICAgICAgICB0aGlzLnBlbmRpbmdEcml2ZXJzW0lubmVyRHJpdmVyLm5hbWVdID0gdGhpcy5wZW5kaW5nRHJpdmVyc1tJbm5lckRyaXZlci5uYW1lXSB8fCBbXTtcbiAgICAgICAgb3RoZXJQZW5kaW5nRHJpdmVyc0RhdGEgPSB0aGlzLnBlbmRpbmdEcml2ZXJzW0lubmVyRHJpdmVyLm5hbWVdLm1hcCgoZHJ2KSA9PiBkcnYuZHJpdmVyRGF0YSk7XG4gICAgICAgIHRoaXMucGVuZGluZ0RyaXZlcnNbSW5uZXJEcml2ZXIubmFtZV0ucHVzaChkKTtcbiAgICAgIH0pO1xuXG4gICAgICB0cnkge1xuICAgICAgICBbaW5uZXJTZXNzaW9uSWQsIGRDYXBzXSA9IGF3YWl0IGQuY3JlYXRlU2Vzc2lvbihcbiAgICAgICAgICBwcm9jZXNzZWRKc29ud3BDYXBhYmlsaXRpZXMsXG4gICAgICAgICAgcmVxQ2FwcyxcbiAgICAgICAgICBwcm9jZXNzZWRXM0NDYXBhYmlsaXRpZXMsXG4gICAgICAgICAgWy4uLnJ1bm5pbmdEcml2ZXJzRGF0YSwgLi4ub3RoZXJQZW5kaW5nRHJpdmVyc0RhdGFdXG4gICAgICAgICk7XG4gICAgICAgIHByb3RvY29sID0gZC5wcm90b2NvbDtcbiAgICAgICAgYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbnNbaW5uZXJTZXNzaW9uSWRdID0gZDtcbiAgICAgICAgfSk7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBhd2FpdCBwZW5kaW5nRHJpdmVyc0d1YXJkLmFjcXVpcmUoQXBwaXVtRHJpdmVyLm5hbWUsICgpID0+IHtcbiAgICAgICAgICBfLnB1bGwodGhpcy5wZW5kaW5nRHJpdmVyc1tJbm5lckRyaXZlci5uYW1lXSwgZCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyB0aGlzIGlzIGFuIGFzeW5jIGZ1bmN0aW9uIGJ1dCB3ZSBkb24ndCBhd2FpdCBpdCBiZWNhdXNlIGl0IGhhbmRsZXNcbiAgICAgIC8vIGFuIG91dC1vZi1iYW5kIHByb21pc2Ugd2hpY2ggaXMgZnVsZmlsbGVkIGlmIHRoZSBpbm5lciBkcml2ZXJcbiAgICAgIC8vIHVuZXhwZWN0ZWRseSBzaHV0cyBkb3duXG4gICAgICB0aGlzLmF0dGFjaFVuZXhwZWN0ZWRTaHV0ZG93bkhhbmRsZXIoZCwgaW5uZXJTZXNzaW9uSWQpO1xuXG5cbiAgICAgIGxvZy5pbmZvKGBOZXcgJHtJbm5lckRyaXZlci5uYW1lfSBzZXNzaW9uIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5LCBzZXNzaW9uIGAgK1xuICAgICAgICAgICAgICBgJHtpbm5lclNlc3Npb25JZH0gYWRkZWQgdG8gbWFzdGVyIHNlc3Npb24gbGlzdGApO1xuXG4gICAgICAvLyBzZXQgdGhlIE5ldyBDb21tYW5kIFRpbWVvdXQgZm9yIHRoZSBpbm5lciBkcml2ZXJcbiAgICAgIGQuc3RhcnROZXdDb21tYW5kVGltZW91dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgZXJyb3IsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBwcm90b2NvbCxcbiAgICAgIHZhbHVlOiBbaW5uZXJTZXNzaW9uSWQsIGRDYXBzLCBwcm90b2NvbF1cbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgYXR0YWNoVW5leHBlY3RlZFNodXRkb3duSGFuZGxlciAoZHJpdmVyLCBpbm5lclNlc3Npb25JZCkge1xuICAgIC8vIFJlbW92ZSB0aGUgc2Vzc2lvbiBvbiB1bmV4cGVjdGVkIHNodXRkb3duLCBzbyB0aGF0IHdlIGFyZSBpbiBhIHBvc2l0aW9uXG4gICAgLy8gdG8gb3BlbiBhbm90aGVyIHNlc3Npb24gbGF0ZXIgb24uXG4gICAgLy8gVE9ETzogdGhpcyBzaG91bGQgYmUgcmVtb3ZlZCBhbmQgcmVwbGFjZWQgYnkgYSBvblNodXRkb3duIGNhbGxiYWNrLlxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBkcml2ZXIub25VbmV4cGVjdGVkU2h1dGRvd247IC8vIHRoaXMgaXMgYSBjYW5jZWxsYWJsZSBwcm9taXNlXG4gICAgICAvLyBpZiB3ZSBnZXQgaGVyZSwgd2UndmUgaGFkIGFuIHVuZXhwZWN0ZWQgc2h1dGRvd24sIHNvIGVycm9yXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgc2h1dGRvd24nKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIEIuQ2FuY2VsbGF0aW9uRXJyb3IpIHtcbiAgICAgICAgLy8gaWYgd2UgY2FuY2VsbGVkIHRoZSB1bmV4cGVjdGVkIHNodXRkb3duIHByb21pc2UsIHRoYXQgbWVhbnMgd2VcbiAgICAgICAgLy8gbm8gbG9uZ2VyIGNhcmUgYWJvdXQgaXQsIGFuZCBjYW4gc2FmZWx5IGlnbm9yZSBpdFxuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsb2cud2FybihgQ2xvc2luZyBzZXNzaW9uLCBjYXVzZSB3YXMgJyR7ZS5tZXNzYWdlfSdgKTtcbiAgICAgIGxvZy5pbmZvKGBSZW1vdmluZyBzZXNzaW9uICR7aW5uZXJTZXNzaW9uSWR9IGZyb20gb3VyIG1hc3RlciBzZXNzaW9uIGxpc3RgKTtcbiAgICAgIGF3YWl0IHNlc3Npb25zTGlzdEd1YXJkLmFjcXVpcmUoQXBwaXVtRHJpdmVyLm5hbWUsICgpID0+IHtcbiAgICAgICAgZGVsZXRlIHRoaXMuc2Vzc2lvbnNbaW5uZXJTZXNzaW9uSWRdO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3VyU2Vzc2lvbkRhdGFGb3JEcml2ZXIgKElubmVyRHJpdmVyKSB7XG4gICAgY29uc3Qgc2Vzc2lvbnMgPSBhd2FpdCBzZXNzaW9uc0xpc3RHdWFyZC5hY3F1aXJlKEFwcGl1bURyaXZlci5uYW1lLCAoKSA9PiB0aGlzLnNlc3Npb25zKTtcbiAgICBjb25zdCBkYXRhID0gXy52YWx1ZXMoc2Vzc2lvbnMpXG4gICAgICAgICAgICAgICAgICAgLmZpbHRlcigocykgPT4gcy5jb25zdHJ1Y3Rvci5uYW1lID09PSBJbm5lckRyaXZlci5uYW1lKVxuICAgICAgICAgICAgICAgICAgIC5tYXAoKHMpID0+IHMuZHJpdmVyRGF0YSk7XG4gICAgZm9yIChsZXQgZGF0dW0gb2YgZGF0YSkge1xuICAgICAgaWYgKCFkYXR1bSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb2JsZW0gZ2V0dGluZyBzZXNzaW9uIGRhdGEgZm9yIGRyaXZlciB0eXBlIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYCR7SW5uZXJEcml2ZXIubmFtZX07IGRvZXMgaXQgaW1wbGVtZW50ICdnZXQgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgZHJpdmVyRGF0YSc/YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoc2Vzc2lvbklkKSB7XG4gICAgbGV0IHByb3RvY29sO1xuICAgIHRyeSB7XG4gICAgICBsZXQgb3RoZXJTZXNzaW9uc0RhdGEgPSBudWxsO1xuICAgICAgbGV0IGRzdFNlc3Npb24gPSBudWxsO1xuICAgICAgYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjdXJDb25zdHJ1Y3Rvck5hbWUgPSB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF0uY29uc3RydWN0b3IubmFtZTtcbiAgICAgICAgb3RoZXJTZXNzaW9uc0RhdGEgPSBfLnRvUGFpcnModGhpcy5zZXNzaW9ucylcbiAgICAgICAgICAgICAgLmZpbHRlcigoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lID09PSBjdXJDb25zdHJ1Y3Rvck5hbWUgJiYga2V5ICE9PSBzZXNzaW9uSWQpXG4gICAgICAgICAgICAgIC5tYXAoKFssIHZhbHVlXSkgPT4gdmFsdWUuZHJpdmVyRGF0YSk7XG4gICAgICAgIGRzdFNlc3Npb24gPSB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF07XG4gICAgICAgIHByb3RvY29sID0gZHN0U2Vzc2lvbi5wcm90b2NvbDtcbiAgICAgICAgbG9nLmluZm8oYFJlbW92aW5nIHNlc3Npb24gJHtzZXNzaW9uSWR9IGZyb20gb3VyIG1hc3RlciBzZXNzaW9uIGxpc3RgKTtcbiAgICAgICAgLy8gcmVnYXJkbGVzcyBvZiB3aGV0aGVyIHRoZSBkZWxldGVTZXNzaW9uIGNvbXBsZXRlcyBzdWNjZXNzZnVsbHkgb3Igbm90XG4gICAgICAgIC8vIG1ha2UgdGhlIHNlc3Npb24gdW5hdmFpbGFibGUsIGJlY2F1c2Ugd2hvIGtub3dzIHdoYXQgc3RhdGUgaXQgbWlnaHRcbiAgICAgICAgLy8gYmUgaW4gb3RoZXJ3aXNlXG4gICAgICAgIGRlbGV0ZSB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF07XG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICB2YWx1ZTogYXdhaXQgZHN0U2Vzc2lvbi5kZWxldGVTZXNzaW9uKHNlc3Npb25JZCwgb3RoZXJTZXNzaW9uc0RhdGEpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3IoYEhhZCB0cm91YmxlIGVuZGluZyBzZXNzaW9uICR7c2Vzc2lvbklkfTogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgZXJyb3I6IGUsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICAvLyBnZXRTdGF0dXMgY29tbWFuZCBzaG91bGQgbm90IGJlIHB1dCBpbnRvIHF1ZXVlLiBJZiB3ZSBkbyBpdCBhcyBwYXJ0IG9mIHN1cGVyLmV4ZWN1dGVDb21tYW5kLCBpdCB3aWxsIGJlIGFkZGVkIHRvIHF1ZXVlLlxuICAgIC8vIFRoZXJlIHdpbGwgYmUgbG90IG9mIHN0YXR1cyBjb21tYW5kcyBpbiBxdWV1ZSBkdXJpbmcgY3JlYXRlU2Vzc2lvbiBjb21tYW5kLCBhcyBjcmVhdGVTZXNzaW9uIGNhbiB0YWtlIHVwIHRvIG9yIG1vcmUgdGhhbiBhIG1pbnV0ZS5cbiAgICBpZiAoY21kID09PSAnZ2V0U3RhdHVzJykge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0U3RhdHVzKCk7XG4gICAgfVxuXG4gICAgaWYgKGlzQXBwaXVtRHJpdmVyQ29tbWFuZChjbWQpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgc3VwZXIuZXhlY3V0ZUNvbW1hbmQoY21kLCAuLi5hcmdzKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uSWQgPSBfLmxhc3QoYXJncyk7XG4gICAgY29uc3QgZHN0U2Vzc2lvbiA9IGF3YWl0IHNlc3Npb25zTGlzdEd1YXJkLmFjcXVpcmUoQXBwaXVtRHJpdmVyLm5hbWUsICgpID0+IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXSk7XG4gICAgaWYgKCFkc3RTZXNzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBzZXNzaW9uIHdpdGggaWQgJyR7c2Vzc2lvbklkfScgZG9lcyBub3QgZXhpc3RgKTtcbiAgICB9XG5cbiAgICBsZXQgcmVzID0ge1xuICAgICAgcHJvdG9jb2w6IGRzdFNlc3Npb24ucHJvdG9jb2xcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIHJlcy52YWx1ZSA9IGF3YWl0IGRzdFNlc3Npb24uZXhlY3V0ZUNvbW1hbmQoY21kLCAuLi5hcmdzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXMuZXJyb3IgPSBlO1xuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgcHJveHlBY3RpdmUgKHNlc3Npb25JZCkge1xuICAgIGNvbnN0IGRzdFNlc3Npb24gPSB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF07XG4gICAgcmV0dXJuIGRzdFNlc3Npb24gJiYgXy5pc0Z1bmN0aW9uKGRzdFNlc3Npb24ucHJveHlBY3RpdmUpICYmIGRzdFNlc3Npb24ucHJveHlBY3RpdmUoc2Vzc2lvbklkKTtcbiAgfVxuXG4gIGdldFByb3h5QXZvaWRMaXN0IChzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBkc3RTZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdO1xuICAgIHJldHVybiBkc3RTZXNzaW9uID8gZHN0U2Vzc2lvbi5nZXRQcm94eUF2b2lkTGlzdCgpIDogW107XG4gIH1cblxuICBjYW5Qcm94eSAoc2Vzc2lvbklkKSB7XG4gICAgY29uc3QgZHN0U2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICByZXR1cm4gZHN0U2Vzc2lvbiAmJiBkc3RTZXNzaW9uLmNhblByb3h5KHNlc3Npb25JZCk7XG4gIH1cbn1cblxuLy8gaGVscCBkZWNpZGUgd2hpY2ggY29tbWFuZHMgc2hvdWxkIGJlIHByb3hpZWQgdG8gc3ViLWRyaXZlcnMgYW5kIHdoaWNoXG4vLyBzaG91bGQgYmUgaGFuZGxlZCBieSB0aGlzLCBvdXIgdW1icmVsbGEgZHJpdmVyXG5mdW5jdGlvbiBpc0FwcGl1bURyaXZlckNvbW1hbmQgKGNtZCkge1xuICByZXR1cm4gIWlzU2Vzc2lvbkNvbW1hbmQoY21kKSB8fCBjbWQgPT09IFwiZGVsZXRlU2Vzc2lvblwiO1xufVxuXG5leHBvcnQgeyBBcHBpdW1Ecml2ZXIgfTtcbiJdLCJmaWxlIjoibGliL2FwcGl1bS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
