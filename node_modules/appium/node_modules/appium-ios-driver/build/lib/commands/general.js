"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var utils = _interopRequireWildcard(require("../utils"));

var _nodeSimctl = require("node-simctl");

var _moment = _interopRequireDefault(require("moment"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = async function () {
  if (this.isWebContext()) {
    return await this.executeAtom('active_element', []);
  } else {
    return await this.uiAutoClient.sendCommand('au.getActiveElement()');
  }
};

commands.getDeviceTime = async function (format = MOMENT_FORMAT_ISO8601) {
  _logger.default.info('Attempting to capture iOS device date and time');

  let cmd;
  let args;
  let inputFormat;

  if (this.isRealDevice()) {
    try {
      cmd = await _appiumSupport.fs.which('idevicedate');
    } catch (err) {
      _logger.default.errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');
    }

    _logger.default.info(`Found idevicedate: '${cmd}'`);

    args = ['-u', this.opts.udid];
    inputFormat = 'ddd MMM DD HH:mm:ss z YYYY';
  } else {
    _logger.default.warn('On simulator. Assuming device time is the same as host time');

    cmd = 'date';
    args = ['+%Y-%m-%dT%H:%M:%S%z'];
    inputFormat = MOMENT_FORMAT_ISO8601;
  }

  const stdout = (await (0, _teen_process.exec)(cmd, args)).stdout.trim();

  _logger.default.debug(`Got the following output out of '${cmd} ${args.join(' ')}': ${stdout}`);

  const parsedTimestamp = (0, _moment.default)(stdout, inputFormat);

  if (!parsedTimestamp.isValid()) {
    _logger.default.warn(`Cannot parse the timestamp '${stdout}' returned by '${cmd}' command. Returning it as is`);

    return stdout;
  }

  return parsedTimestamp.format(format);
};

commands.hideKeyboard = async function (strategy, ...possibleKeys) {
  possibleKeys.pop();
  let cmd;

  let key = _lodash.default.find(possibleKeys, k => {
    return k;
  });

  if (key) {
    strategy = strategy || 'pressKey';
    cmd = `au.hideKeyboard('${strategy}', '${key}')`;
  } else {
    strategy = strategy || 'default';
    cmd = `au.hideKeyboard('${strategy}')`;
  }

  await this.uiAutoClient.sendCommand(cmd);
};

commands.getPageSource = async function () {
  if (this.isWebContext()) {
    const script = 'return document.documentElement.outerHTML';
    return await this.executeAtom('execute_script', [script, []]);
  } else {
    return await this.getNativePageSource();
  }
};

helpers.getNativePageSource = async function () {
  let jsonSource = await this.getSourceForElementForXML();

  if (typeof jsonSource === 'string') {
    jsonSource = JSON.parse(jsonSource);
  }

  let xmlSource = (0, _js2xmlparser.default)('AppiumAUT', jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: 'element'
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: '    '
    }
  });
  return xmlSource;
};

commands.background = async function (secs) {
  await this.uiAutoClient.sendCommand(`au.background(${secs})`);
};

commands.lock = async function (secs) {
  if (!secs) {
    _logger.default.debug('No seconds parameter. Using 0 seconds');

    secs = 0;
  }

  await this.uiAutoClient.sendCommand(`au.lock(${secs})`);
};

commands.closeApp = async function () {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.stop();

    _logger.default.info(`Successfully closed the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while closing the '${appName}' app.`);

    throw err;
  }
};

commands.launchApp = async function () {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.start();

    _logger.default.info(`Successfully launched the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while launching the '${appName}' app.`);

    throw err;
  }
};

commands.removeApp = async function (bundleId) {
  if (this.isRealDevice()) {
    await this.realDevice.remove(bundleId);
  } else {
    await this.sim.removeApp(bundleId);
  }
};

commands.keys = async function (keys) {
  if (this.isWebContext()) {
    let el = await this.active();

    if (_lodash.default.isUndefined(el.ELEMENT)) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    await this.setValue(keys, el.ELEMENT);
  } else {
    if (_lodash.default.isArray(keys)) {
      keys = keys.join('');
    }

    if (!_lodash.default.isString(keys)) {
      keys = keys.toString();
    }

    keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
    let command = `au.sendKeysToActiveElement('${keys}')`;
    await this.uiAutoClient.sendCommand(command);
  }
};

commands.setGeoLocation = async function (location) {
  await this.uiAutoClient.sendCommand(`target.setLocation(${JSON.stringify(location)})`);
};

commands.getWindowSize = async function (windowHandle = 'current') {
  if (windowHandle !== 'current') {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
  }

  if (this.isWebContext()) {
    return await this.executeAtom('get_window_size', []);
  } else {
    return await this.uiAutoClient.sendCommand('au.getWindowSize()');
  }
};

commands.getWindowRect = async function () {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.getStrings = async function (language, stringFile = null) {
  _logger.default.debug(`Gettings strings for language '${language}' and string file '${stringFile}'`);

  return await utils.parseLocalizableStrings(Object.assign({}, this.opts, {
    language,
    stringFile,
    strictMode: true
  }));
};

commands.setUrl = async function (url) {
  _logger.default.debug(`Attempting to set url '${url}'`);

  if (!this.isWebContext()) {
    await (0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, url);
    return;
  }

  this.setCurrentUrl(url);
  this.curWebFrames = [];
  await this.remote.navToUrl(url);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiZ2V0RGV2aWNlVGltZSIsImZvcm1hdCIsImxvZyIsImluZm8iLCJjbWQiLCJhcmdzIiwiaW5wdXRGb3JtYXQiLCJpc1JlYWxEZXZpY2UiLCJmcyIsIndoaWNoIiwiZXJyIiwiZXJyb3JBbmRUaHJvdyIsIm9wdHMiLCJ1ZGlkIiwid2FybiIsInN0ZG91dCIsInRyaW0iLCJkZWJ1ZyIsImpvaW4iLCJwYXJzZWRUaW1lc3RhbXAiLCJpc1ZhbGlkIiwiaGlkZUtleWJvYXJkIiwic3RyYXRlZ3kiLCJwb3NzaWJsZUtleXMiLCJwb3AiLCJrZXkiLCJfIiwiZmluZCIsImsiLCJnZXRQYWdlU291cmNlIiwic2NyaXB0IiwiZ2V0TmF0aXZlUGFnZVNvdXJjZSIsImpzb25Tb3VyY2UiLCJnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIiwiSlNPTiIsInBhcnNlIiwieG1sU291cmNlIiwid3JhcEFycmF5IiwiZW5hYmxlZCIsImVsZW1lbnROYW1lIiwiZGVjbGFyYXRpb24iLCJpbmNsdWRlIiwicHJldHR5UHJpbnRpbmciLCJpbmRlbnRTdHJpbmciLCJiYWNrZ3JvdW5kIiwic2VjcyIsImxvY2siLCJjbG9zZUFwcCIsImFwcE5hbWUiLCJhcHAiLCJidW5kbGVJZCIsInN0b3AiLCJsYXVuY2hBcHAiLCJzdGFydCIsInJlbW92ZUFwcCIsInJlYWxEZXZpY2UiLCJyZW1vdmUiLCJzaW0iLCJrZXlzIiwiZWwiLCJpc1VuZGVmaW5lZCIsIkVMRU1FTlQiLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJzZXRWYWx1ZSIsImlzQXJyYXkiLCJpc1N0cmluZyIsInRvU3RyaW5nIiwidXRpbCIsImVzY2FwZVNwZWNpYWxDaGFycyIsImNvbW1hbmQiLCJzZXRHZW9Mb2NhdGlvbiIsImxvY2F0aW9uIiwic3RyaW5naWZ5IiwiZ2V0V2luZG93U2l6ZSIsIndpbmRvd0hhbmRsZSIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJnZXRXaW5kb3dSZWN0Iiwid2lkdGgiLCJoZWlnaHQiLCJ4IiwieSIsImdldFN0cmluZ3MiLCJsYW5ndWFnZSIsInN0cmluZ0ZpbGUiLCJ1dGlscyIsInBhcnNlTG9jYWxpemFibGVTdHJpbmdzIiwiT2JqZWN0IiwiYXNzaWduIiwic3RyaWN0TW9kZSIsInNldFVybCIsInVybCIsInNldEN1cnJlbnRVcmwiLCJjdXJXZWJGcmFtZXMiLCJyZW1vdGUiLCJuYXZUb1VybCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7OztBQUVBLE1BQU1DLHFCQUFxQixHQUFHLHNCQUE5Qjs7QUFFQUgsUUFBUSxDQUFDSSxNQUFULEdBQWtCLGtCQUFrQjtBQUNsQyxNQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixXQUFPLE1BQU0sS0FBS0MsV0FBTCxDQUFpQixnQkFBakIsRUFBbUMsRUFBbkMsQ0FBYjtBQUNELEdBRkQsTUFFTztBQUNMLFdBQU8sTUFBTSxLQUFLQyxZQUFMLENBQWtCQyxXQUFsQixDQUE4Qix1QkFBOUIsQ0FBYjtBQUNEO0FBQ0YsQ0FORDs7QUFpQkFSLFFBQVEsQ0FBQ1MsYUFBVCxHQUF5QixnQkFBZ0JDLE1BQU0sR0FBR1AscUJBQXpCLEVBQWdEO0FBQ3ZFUSxrQkFBSUMsSUFBSixDQUFTLGdEQUFUOztBQUNBLE1BQUlDLEdBQUo7QUFDQSxNQUFJQyxJQUFKO0FBQ0EsTUFBSUMsV0FBSjs7QUFDQSxNQUFJLEtB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WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBqczJ4bWwgZnJvbSAnanMyeG1scGFyc2VyMic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgb3BlblVybCB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50JztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBNT01FTlRfRk9STUFUX0lTTzg2MDEgPSAnWVlZWS1NTS1ERFRISDptbTpzc1onO1xuXG5jb21tYW5kcy5hY3RpdmUgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2FjdGl2ZV9lbGVtZW50JywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCgnYXUuZ2V0QWN0aXZlRWxlbWVudCgpJyk7XG4gIH1cbn07XG5cbi8qKlxuICogUmV0cmlldmVzIHRoZSBjdXJyZW50IGRldmljZSdzIHRpbWVzdGFtcC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZm9ybWF0IC0gVGhlIHNldCBvZiBmb3JtYXQgc3BlY2lmaWVycy4gUmVhZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBzOi8vbW9tZW50anMuY29tL2RvY3MvIHRvIGdldCB0aGUgZnVsbCBsaXN0IG9mIHN1cHBvcnRlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGV0aW1lIGZvcm1hdCBzcGVjaWZpZXJzLiBUaGUgZGVmYXVsdCBmb3JtYXQgaXNcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBgWVlZWS1NTS1ERFRISDptbTpzc1pgLCB3aGljaCBjb21wbGllcyB0byBJU08tODYwMVxuICogQHJldHVybnMgRm9ybWF0dGVkIGRhdGV0aW1lIHN0cmluZyBvciB0aGUgcmF3IGNvbW1hbmQgb3V0cHV0IGlmIGZvcm1hdHRpbmcgZmFpbHNcbiAqL1xuY29tbWFuZHMuZ2V0RGV2aWNlVGltZSA9IGFzeW5jIGZ1bmN0aW9uIChmb3JtYXQgPSBNT01FTlRfRk9STUFUX0lTTzg2MDEpIHtcbiAgbG9nLmluZm8oJ0F0dGVtcHRpbmcgdG8gY2FwdHVyZSBpT1MgZGV2aWNlIGRhdGUgYW5kIHRpbWUnKTtcbiAgbGV0IGNtZDtcbiAgbGV0IGFyZ3M7XG4gIGxldCBpbnB1dEZvcm1hdDtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0cnkge1xuICAgICAgY21kID0gYXdhaXQgZnMud2hpY2goJ2lkZXZpY2VkYXRlJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGNhcHR1cmUgZGV2aWNlIGRhdGUgYW5kIHRpbWUgdXNpbmcgbGliaW1vYmlsZWRldmljZSBpZGV2aWNlZGF0ZS4gJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnTGliaW1vYmlsZWRldmljZSBpcyBwcm9iYWJseSBub3QgaW5zdGFsbGVkJyk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBGb3VuZCBpZGV2aWNlZGF0ZTogJyR7Y21kfSdgKTtcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbGliaW1vYmlsZWRldmljZS9saWJpbW9iaWxlZGV2aWNlL2Jsb2IvMjYzNzNiMzM0ODg5ZjVhZTJlMjczN2ZmNDQ3ZWIyNWIxNzAwZmEyZi90b29scy9pZGV2aWNlZGF0ZS5jI0wxMjlcbiAgICBhcmdzID0gWyctdScsIHRoaXMub3B0cy51ZGlkXTtcbiAgICBpbnB1dEZvcm1hdCA9ICdkZGQgTU1NIEREIEhIOm1tOnNzIHogWVlZWSc7XG4gIH0gZWxzZSB7XG4gICAgbG9nLndhcm4oJ09uIHNpbXVsYXRvci4gQXNzdW1pbmcgZGV2aWNlIHRpbWUgaXMgdGhlIHNhbWUgYXMgaG9zdCB0aW1lJyk7XG4gICAgY21kID0gJ2RhdGUnO1xuICAgIGFyZ3MgPSBbJyslWS0lbS0lZFQlSDolTTolUyV6J107XG4gICAgaW5wdXRGb3JtYXQgPSBNT01FTlRfRk9STUFUX0lTTzg2MDE7XG4gIH1cbiAgY29uc3Qgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoY21kLCBhcmdzKSkuc3Rkb3V0LnRyaW0oKTtcbiAgbG9nLmRlYnVnKGBHb3QgdGhlIGZvbGxvd2luZyBvdXRwdXQgb3V0IG9mICcke2NtZH0gJHthcmdzLmpvaW4oJyAnKX0nOiAke3N0ZG91dH1gKTtcbiAgY29uc3QgcGFyc2VkVGltZXN0YW1wID0gbW9tZW50KHN0ZG91dCwgaW5wdXRGb3JtYXQpO1xuICBpZiAoIXBhcnNlZFRpbWVzdGFtcC5pc1ZhbGlkKCkpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHBhcnNlIHRoZSB0aW1lc3RhbXAgJyR7c3Rkb3V0fScgcmV0dXJuZWQgYnkgJyR7Y21kfScgY29tbWFuZC4gUmV0dXJuaW5nIGl0IGFzIGlzYCk7XG4gICAgcmV0dXJuIHN0ZG91dDtcbiAgfVxuICByZXR1cm4gcGFyc2VkVGltZXN0YW1wLmZvcm1hdChmb3JtYXQpO1xufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBsZXQgY21kO1xuICBsZXQga2V5ID0gXy5maW5kKHBvc3NpYmxlS2V5cywgKGspID0+IHtyZXR1cm4gazt9KTtcbiAgaWYgKGtleSkge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ3ByZXNzS2V5JztcbiAgICBjbWQgPSBgYXUuaGlkZUtleWJvYXJkKCcke3N0cmF0ZWd5fScsICcke2tleX0nKWA7XG4gIH0gZWxzZSB7XG4gICAgc3RyYXRlZ3kgPSBzdHJhdGVneSB8fCAnZGVmYXVsdCc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nKWA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY21kKTtcbn07XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgY29uc3Qgc2NyaXB0ID0gJ3JldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub3V0ZXJIVE1MJztcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbXV0pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldE5hdGl2ZVBhZ2VTb3VyY2UoKTtcbiAgfVxufTtcblxuaGVscGVycy5nZXROYXRpdmVQYWdlU291cmNlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQganNvblNvdXJjZSA9IGF3YWl0IHRoaXMuZ2V0U291cmNlRm9yRWxlbWVudEZvclhNTCgpO1xuICBpZiAodHlwZW9mIGpzb25Tb3VyY2UgPT09ICdzdHJpbmcnKSB7XG4gICAganNvblNvdXJjZSA9IEpTT04ucGFyc2UoanNvblNvdXJjZSk7XG4gIH1cbiAgbGV0IHhtbFNvdXJjZSA9IGpzMnhtbCgnQXBwaXVtQVVUJywganNvblNvdXJjZSwge1xuICAgIHdyYXBBcnJheToge2VuYWJsZWQ6IGZhbHNlLCBlbGVtZW50TmFtZTogJ2VsZW1lbnQnfSxcbiAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgIHByZXR0eVByaW50aW5nOiB7aW5kZW50U3RyaW5nOiAnICAgICd9XG4gIH0pO1xuICByZXR1cm4geG1sU291cmNlO1xufTtcblxuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgaWYgKCFzZWNzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzZWNvbmRzIHBhcmFtZXRlci4gVXNpbmcgMCBzZWNvbmRzJyk7XG4gICAgc2VjcyA9IDA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmxvY2soJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgY2xvc2VkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgY2xvc2luZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVhbERldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2ltLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiAoa2V5cykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuYWN0aXZlKCk7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNBcnJheShrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMuam9pbignJyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMudG9TdHJpbmcoKTtcbiAgICB9XG4gICAga2V5cyA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGtleXMsIFwiJ1wiKTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vIGxldCBoYXNPcHRpb25zID0gYWx0aXR1ZGUgIT09IG51bGwgfHwgaG9yaXpvbnRhbEFjY3VyYWN5ICE9PSBudWxsIHx8IHZlcnRpY2FsQWNjdXJhY3kgIT09IG51bGwgfHwgY291cnNlICE9PSBudWxsIHx8IHNwZWVkICE9PSBudWxsO1xuICAvLyBpZiAoaGFzT3B0aW9ucykge1xuICAvLyAgIGxldCBvcHRpb25zID0ge307XG4gIC8vICAgaWYgKGFsdGl0dWRlICE9PSBudWxsKSB7XG4gIC8vICAgICBvcHRpb25zLmFsdGl0dWRlID0gYWx0aXR1ZGU7XG4gIC8vICAgfVxuICAvLyAgIGlmIChob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwpIHtcbiAgLy8gICAgIG9wdGlvbnMuaG9yaXpvbnRhbEFjY3VyYWN5ID0gaG9yaXpvbnRhbEFjY3VyYWN5O1xuICAvLyAgIH1cbiAgLy8gICBpZiAodmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy52ZXJ0aWNhbEFjY3VyYWN5ID0gdmVydGljYWxBY2N1cmFjeTtcbiAgLy8gICB9XG4gIC8vICAgaWYgKGNvdXJzZSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5jb3Vyc2UgPSBjb3Vyc2U7XG4gIC8vICAgfVxuICAvLyAgIGlmIChzcGVlZCAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5zcGVlZCA9IHNwZWVkO1xuICAvLyAgIH1cbiAgLy8gICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcbiAgLy8gICAgIGB0YXJnZXQuc2V0TG9jYXRpb25XaXRoT3B0aW9ucygke0pTT04uc3RyaW5naWZ5KGNvb3JkaW5hdGVzKX0sICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucyl9KWApO1xuICAvLyB9IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy8gfVxufTtcblxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uICh3aW5kb3dIYW5kbGUgPSAnY3VycmVudCcpIHtcbiAgaWYgKHdpbmRvd0hhbmRsZSAhPT0gJ2N1cnJlbnQnKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCdDdXJyZW50bHkgb25seSBnZXR0aW5nIGN1cnJlbnQgd2luZG93IHNpemUgaXMgc3VwcG9ydGVkLicpO1xuICB9XG5cbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCgnYXUuZ2V0V2luZG93U2l6ZSgpJyk7XG4gIH1cbn07XG5cbi8vIEZvciBXM0NcbmNvbW1hbmRzLmdldFdpbmRvd1JlY3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuICByZXR1cm4ge1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICB4OiAwLFxuICAgIHk6IDBcbiAgfTtcbn07XG5cbmNvbW1hbmRzLmdldFN0cmluZ3MgPSBhc3luYyBmdW5jdGlvbiAobGFuZ3VhZ2UsIHN0cmluZ0ZpbGUgPSBudWxsKSB7XG4gIGxvZy5kZWJ1ZyhgR2V0dGluZ3Mgc3RyaW5ncyBmb3IgbGFuZ3VhZ2UgJyR7bGFuZ3VhZ2V9JyBhbmQgc3RyaW5nIGZpbGUgJyR7c3RyaW5nRmlsZX0nYCk7XG4gIHJldHVybiBhd2FpdCB1dGlscy5wYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdHMsIHtcbiAgICBsYW5ndWFnZSxcbiAgICBzdHJpbmdGaWxlLFxuICAgIHN0cmljdE1vZGU6IHRydWUsXG4gIH0pKTtcbn07XG5cbmNvbW1hbmRzLnNldFVybCA9IGFzeW5jIGZ1bmN0aW9uICh1cmwpIHtcbiAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHNldCB1cmwgJyR7dXJsfSdgKTtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgLy8gdXNlIHhjcnVuIHRvIG9wZW4gZGVlcGxpbmtcbiAgICBhd2FpdCBvcGVuVXJsKHRoaXMub3B0cy51ZGlkIHx8IHRoaXMuc2ltLnVkaWQsIHVybCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIHRoaXMuc2V0Q3VycmVudFVybCh1cmwpO1xuICAvLyBtYWtlIHN1cmUgdG8gY2xlYXIgb3V0IGFueSBsZWZ0b3ZlciB3ZWIgZnJhbWVzXG4gIHRoaXMuY3VyV2ViRnJhbWVzID0gW107XG4gIGF3YWl0IHRoaXMucmVtb3RlLm5hdlRvVXJsKHVybCk7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
